<html lang="ko"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ë‚´ìœ„ì¹˜ì•ˆë‚´ ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ì‹œìŠ¤í…œ</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .status-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .card-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }

        .sensor-data {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }

        .sensor-label {
            font-weight: 600;
            color: #34495e;
        }

        .sensor-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #2980b9;
        }

        .status-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        .status-normal {
            background-color: #27ae60;
        }

        .status-warning {
            background-color: #f39c12;
        }

        .status-danger {
            background-color: #e74c3c;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .alert-message {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s ease;
        }

        .alert-normal {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-fall {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            animation: blink 1s infinite;
        }

        .alert-obstacle {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .connection-status {
            text-align: center;
            padding: 15px;
            margin: 20px;
            border-radius: 10px;
            font-weight: bold;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .timestamp {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 20px;
        }

        .code-toggle {
            background: rgba(255, 255, 255, 0.9);
            margin: 20px;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        .code-toggle label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            color: #2c3e50;
        }

        .code-toggle input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .arduino-code {
            display: none;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            margin: 20px;
            border-radius: 10px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: auto;
            position: relative;
        }

        .arduino-code.show {
            display: block;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .code-title {
            color: #569cd6;
            font-weight: bold;
            font-size: 16px;
        }

        .copy-btn {
            background: #0078d4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .copy-btn:hover {
            background: #106ebe;
        }

        .copy-btn.copied {
            background: #107c10;
        }

        .code-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦¯ ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ</h1>
            <p>ì‹¤ì‹œê°„ ì„¼ì„œ ë°ì´í„° ë° ì•ˆì „ ìƒíƒœ ëª¨ë‹ˆí„°ë§</p>
        </div>

        <div class="code-toggle">
            <label>
                <input type="checkbox" id="codeToggle">
                ğŸ”§ Arduino UNO R4 WIFI ì½”ë“œ ë³´ê¸°
            </label>
        </div>

        <div class="arduino-code" id="arduinoCode">
            <div class="code-header">
                <div class="code-title">ğŸ”§ Arduino UNO R4 WIFI - ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ì‹œìŠ¤í…œ</div>
                <button class="copy-btn" id="copyBtn">ğŸ“‹ ë³µì‚¬</button>
            </div>
            <div class="code-content" id="codeContent"></div>
        </div>

        <div class="code-toggle">
            <label>
                <input type="checkbox" id="nanoCodeToggle">
                ğŸ“± Arduino Nano 33 BLE ì½”ë“œ ë³´ê¸°
            </label>
        </div>

        <div class="arduino-code" id="nanoArduinoCode">
            <div class="code-header">
                <div class="code-title">ğŸ“± Arduino Nano 33 BLE - ë‚™ìƒ ê°ì§€ ì‹œìŠ¤í…œ</div>
                <button class="copy-btn" id="nanoCopyBtn">ğŸ“‹ ë³µì‚¬</button>
            </div>
            <div class="code-content" id="nanoCodeContent"></div>
        </div>

        <div class="code-toggle">
            <label>
                <input type="checkbox" id="monitoringCodeToggle">
                ğŸ¦¯ ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ëª¨ë‹ˆí„°ë§ ì½”ë“œ ë³´ê¸°
            </label>
        </div>

        <div class="arduino-code" id="monitoringCode">
            <div class="code-header">
                <div class="code-title">ğŸ¦¯ ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ - JavaScript</div>
                <button class="copy-btn" id="monitoringCopyBtn">ğŸ“‹ ë³µì‚¬</button>
            </div>
            <div class="code-content" id="monitoringCodeContent">// ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ - JavaScript Core Functions

// MQTT ì—°ê²° ë° ë©”ì‹œì§€ ì²˜ë¦¬
const MQTT_TOPIC_SUB = 'SC_pub';
let client;
let isConnected = false;

// ìŒì„± ì•Œë¦¼ ì œì–´ ë³€ìˆ˜
let lastSpeechTime = 0;
let lastSensorSpeech = 0;
const speechCooldown = 10000; // 10ì´ˆ ê°„ê²©

// ì•± ì´ˆê¸°í™” í•¨ìˆ˜
function initializeApp() {
    // DOM ìš”ì†Œë“¤ ì´ˆê¸°í™”
    connectionStatus = document.getElementById('connectionStatus');
    distance1 = document.getElementById('distance1');
    distance2 = document.getElementById('distance2');
    status1 = document.getElementById('status1');
    status2 = document.getElementById('status2');
    safetyStatus = document.getElementById('safetyStatus');
    fallStatus = document.getElementById('fallStatus');
    obstacleStatus = document.getElementById('obstacleStatus');
    lastUpdate = document.getElementById('lastUpdate');

    // MQTT ì—°ê²° ì„¤ì •
    const clientId = 'webClient_' + Math.random().toString(16).substr(2, 8);
    const isHttps = location.protocol === 'https:';
    const mqttUrl = isHttps ? 'wss://pubcode2.iptime.org:39002' : 'ws://pubcode2.iptime.org:39001';
    
    try {
        client = mqtt.connect(mqttUrl, {
            clientId: clientId,
            clean: true,
            keepalive: 30,
            connectTimeout: 15 * 1000,
            reconnectPeriod: 5000,
            protocolVersion: 4
        });
        setupMQTTEvents();
    } catch (error) {
        console.error('MQTT í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
        updateConnectionStatus(false, 'MQTT ì—°ê²° ì‹¤íŒ¨');
    }
}

// MQTT ë©”ì‹œì§€ ì²˜ë¦¬ í•¨ìˆ˜
function processMessage(data) {
    console.log('ì²˜ë¦¬ ì¤‘ì¸ ë©”ì‹œì§€:', data);
    
    // ë‚™ìƒ ê°ì§€ ì²´í¬
    if (data.includes('"event":"FALL"') || data === 'FALL') {
        handleFallDetection();
        return;
    }
    
    // JSON í˜•íƒœ ë°ì´í„° íŒŒì‹±
    try {
        const jsonData = JSON.parse(data);
        if (jsonData.event === 'FALL') {
            handleFallDetection();
            return;
        }
        if (jsonData.sensor1 !== undefined &amp;&amp; jsonData.sensor2 !== undefined) {
            updateSensorDisplay(1, jsonData.sensor1);
            updateSensorDisplay(2, jsonData.sensor2);
            return;
        }
    } catch (e) {
        // JSONì´ ì•„ë‹Œ ê²½ìš° ë‹¤ë¥¸ íŒŒì‹± ë°©ë²• ì‹œë„
    }
    
    // ê±°ë¦¬ ë°ì´í„° íŒŒì‹±
    if (data.includes('Distance Alert!')) {
        handleDistanceAlert(data);
        parseDistanceData(data);
    } else if (data.includes('d1=') &amp;&amp; data.includes('d2=')) {
        parseDistanceData(data);
    } else if (data.includes('ì„¼ì„œ1') &amp;&amp; data.includes('ì„¼ì„œ2')) {
        parseKoreanDistanceData(data);
    }
}

// ìŒì„± ì•Œë¦¼ í•¨ìˆ˜ (Chrome ë¸Œë¼ìš°ì € í˜¸í™˜)
function speakMessage(message, priority = 'normal') {
    const currentTime = Date.now();
    
    if (priority === 'high' || currentTime - lastSpeechTime &gt; speechCooldown) {
        if ('speechSynthesis' in window) {
            try {
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(message);
                const voices = window.speechSynthesis.getVoices();
                const koreanVoice = voices.find(voice =&gt; 
                    voice.lang.includes('ko') || voice.lang.includes('KR')
                );
                
                if (koreanVoice) {
                    utterance.voice = koreanVoice;
                    utterance.lang = koreanVoice.lang;
                } else {
                    utterance.lang = 'ko-KR';
                }
                
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                window.speechSynthesis.speak(utterance);
                lastSpeechTime = currentTime;
                
            } catch (error) {
                console.error('ìŒì„± í•©ì„± ì˜¤ë¥˜:', error);
                showTextAlert(message);
            }
        } else {
            showTextAlert(message);
        }
    }
}

// ë‚™ìƒ ê°ì§€ ì²˜ë¦¬
function handleFallDetection() {
    fallStatus.textContent = 'ğŸš¨ ë‚™ìƒ ê°ì§€ë¨!';
    fallStatus.className = 'alert-message alert-fall';
    safetyStatus.textContent = 'ğŸš¨ ì‘ê¸‰ ìƒí™© ë°œìƒ!';
    safetyStatus.className = 'alert-message alert-fall';

    speakMessage('ê²½ê³ ! ë‚™ìƒì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì‘ê¸‰ ìƒí™©ì…ë‹ˆë‹¤.', 'high');

    setTimeout(() =&gt; {
        fallStatus.textContent = 'ì •ìƒ ìƒíƒœ';
        fallStatus.className = 'alert-message alert-normal';
        updateSafetyStatus();
        speakMessage('ë‚™ìƒ ê²½ê³ ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }, 5000);
}

// ì„¼ì„œ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateSensorDisplay(sensorNum, distance) {
    console.log(`ì„¼ì„œ${sensorNum} ì—…ë°ì´íŠ¸: ${distance}cm`);
    
    if (sensorNum === 1) {
        distance1.textContent = distance + ' cm';
        updateSensorStatus(status1, distance);
    } else if (sensorNum === 2) {
        distance2.textContent = distance + ' cm';
        updateSensorStatus(status2, distance);
    }

    // ì¥ì• ë¬¼ ê°ì§€ ì²´í¬
    if (distance &lt; 20) {
        triggerObstacleAlert(sensorNum, distance);
    }
}

// ì¥ì• ë¬¼ ê²½ê³  íŠ¸ë¦¬ê±°
function triggerObstacleAlert(sensorNum, distance) {
    obstacleStatus.textContent = `âš ï¸ ì„¼ì„œ${sensorNum}ì—ì„œ ì¥ì• ë¬¼ ê°ì§€! (${distance}cm)`;
    obstacleStatus.className = 'alert-message alert-obstacle';
    safetyStatus.textContent = 'âš ï¸ ì£¼ì˜ í•„ìš”';
    safetyStatus.className = 'alert-message alert-obstacle';

    speakMessage(`ì£¼ì˜! ì„¼ì„œ ${sensorNum}ì—ì„œ ${distance}ì„¼í‹°ë¯¸í„° ê±°ë¦¬ì— ì¥ì• ë¬¼ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'high');

    setTimeout(() =&gt; {
        if (!obstacleStatus.className.includes('alert-obstacle')) return;
        obstacleStatus.textContent = 'ê²½ë¡œ ì•ˆì „';
        obstacleStatus.className = 'alert-message alert-normal';
        updateSafetyStatus();
        speakMessage('ì¥ì• ë¬¼ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ê²½ë¡œê°€ ì•ˆì „í•©ë‹ˆë‹¤.');
    }, 3000);
}</div>
        </div>

        <div class="code-toggle">
            <label>
                <input type="checkbox" id="htmlCodeToggle">
                ğŸ“„ index.html ì „ì²´ ì½”ë“œ ë³´ê¸°
            </label>
        </div>

        <div class="arduino-code" id="htmlCode">
            <div class="code-header">
                <div class="code-title">ğŸ“„ index.html - ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ëª¨ë‹ˆí„°ë§ ì›¹í˜ì´ì§€</div>
                <button class="copy-btn" id="htmlCopyBtn">ğŸ“‹ ë³µì‚¬</button>
            </div>
            <div class="code-content" id="htmlCodeContent">&lt;html lang="ko"&gt;&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;ì‹¤ë‚´ìœ„ì¹˜ì•ˆë‚´ ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ì‹œìŠ¤í…œ&lt;/title&gt;
    &lt;script src="https://unpkg.com/mqtt/dist/mqtt.min.js"&gt;&lt;/script&gt;
    &lt;style&gt;
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .status-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .card-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }

        .sensor-data {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }

        .sensor-label {
            font-weight: 600;
            color: #34495e;
        }

        .sensor-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #2980b9;
        }

        .status-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        .status-normal {
            background-color: #27ae60;
        }

        .status-warning {
            background-color: #f39c12;
        }

        .status-danger {
            background-color: #e74c3c;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .alert-message {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s ease;
        }

        .alert-normal {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-fall {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            animation: blink 1s infinite;
        }

        .alert-obstacle {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .connection-status {
            text-align: center;
            padding: 15px;
            margin: 20px;
            border-radius: 10px;
            font-weight: bold;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .timestamp {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 20px;
        }

        .code-toggle {
            background: rgba(255, 255, 255, 0.9);
            margin: 20px;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        .code-toggle label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            color: #2c3e50;
        }

        .code-toggle input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .arduino-code {
            display: none;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            margin: 20px;
            border-radius: 10px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: auto;
            position: relative;
        }

        .arduino-code.show {
            display: block;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .code-title {
            color: #569cd6;
            font-weight: bold;
            font-size: 16px;
        }

        .copy-btn {
            background: #0078d4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .copy-btn:hover {
            background: #106ebe;
        }

        .copy-btn.copied {
            background: #107c10;
        }

        .code-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container"&gt;
        &lt;div class="header"&gt;
            &lt;h1&gt;ğŸ¦¯ ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ&lt;/h1&gt;
            &lt;p&gt;ì‹¤ì‹œê°„ ì„¼ì„œ ë°ì´í„° ë° ì•ˆì „ ìƒíƒœ ëª¨ë‹ˆí„°ë§&lt;/p&gt;
        &lt;/div&gt;

        &lt;div class="code-toggle"&gt;
            &lt;label&gt;
                &lt;input type="checkbox" id="codeToggle"&gt;
                ğŸ”§ Arduino UNO R4 WIFI ì½”ë“œ ë³´ê¸°
            &lt;/label&gt;
        &lt;/div&gt;

        &lt;div class="arduino-code" id="arduinoCode"&gt;
            &lt;div class="code-header"&gt;
                &lt;div class="code-title"&gt;ğŸ”§ Arduino UNO R4 WIFI - ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ì‹œìŠ¤í…œ&lt;/div&gt;
                &lt;button class="copy-btn" id="copyBtn"&gt;ğŸ“‹ ë³µì‚¬&lt;/button&gt;
            &lt;/div&gt;
            &lt;div class="code-content" id="codeContent"&gt;&lt;/div&gt;
        &lt;/div&gt;

        &lt;div class="code-toggle"&gt;
            &lt;label&gt;
                &lt;input type="checkbox" id="nanoCodeToggle"&gt;
                ğŸ“± Arduino Nano 33 BLE ì½”ë“œ ë³´ê¸°
            &lt;/label&gt;
        &lt;/div&gt;

        &lt;div class="arduino-code" id="nanoArduinoCode"&gt;
            &lt;div class="code-header"&gt;
                &lt;div class="code-title"&gt;ğŸ“± Arduino Nano 33 BLE - ë‚™ìƒ ê°ì§€ ì‹œìŠ¤í…œ&lt;/div&gt;
                &lt;button class="copy-btn" id="nanoCopyBtn"&gt;ğŸ“‹ ë³µì‚¬&lt;/button&gt;
            &lt;/div&gt;
            &lt;div class="code-content" id="nanoCodeContent"&gt;&lt;/div&gt;
        &lt;/div&gt;

        &lt;div class="code-toggle"&gt;
            &lt;label&gt;
                &lt;input type="checkbox" id="monitoringCodeToggle"&gt;
                ğŸ¦¯ ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ëª¨ë‹ˆí„°ë§ ì½”ë“œ ë³´ê¸°
            &lt;/label&gt;
        &lt;/div&gt;

        &lt;div class="arduino-code" id="monitoringCode"&gt;
            &lt;div class="code-header"&gt;
                &lt;div class="code-title"&gt;ğŸ¦¯ ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ - JavaScript&lt;/div&gt;
                &lt;button class="copy-btn" id="monitoringCopyBtn"&gt;ğŸ“‹ ë³µì‚¬&lt;/button&gt;
            &lt;/div&gt;
            &lt;div class="code-content" id="monitoringCodeContent"&gt;// ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ - JavaScript Core Functions

// MQTT ì—°ê²° ë° ë©”ì‹œì§€ ì²˜ë¦¬
const MQTT_TOPIC_SUB = 'SC_pub';
let client;
let isConnected = false;

// ìŒì„± ì•Œë¦¼ ì œì–´ ë³€ìˆ˜
let lastSpeechTime = 0;
let lastSensorSpeech = 0;
const speechCooldown = 10000; // 10ì´ˆ ê°„ê²©

// ì•± ì´ˆê¸°í™” í•¨ìˆ˜
function initializeApp() {
    // DOM ìš”ì†Œë“¤ ì´ˆê¸°í™”
    connectionStatus = document.getElementById('connectionStatus');
    distance1 = document.getElementById('distance1');
    distance2 = document.getElementById('distance2');
    status1 = document.getElementById('status1');
    status2 = document.getElementById('status2');
    safetyStatus = document.getElementById('safetyStatus');
    fallStatus = document.getElementById('fallStatus');
    obstacleStatus = document.getElementById('obstacleStatus');
    lastUpdate = document.getElementById('lastUpdate');

    // MQTT ì—°ê²° ì„¤ì •
    const clientId = 'webClient_' + Math.random().toString(16).substr(2, 8);
    const isHttps = location.protocol === 'https:';
    const mqttUrl = isHttps ? 'wss://pubcode2.iptime.org:39002' : 'ws://pubcode2.iptime.org:39001';
    
    try {
        client = mqtt.connect(mqttUrl, {
            clientId: clientId,
            clean: true,
            keepalive: 30,
            connectTimeout: 15 * 1000,
            reconnectPeriod: 5000,
            protocolVersion: 4
        });
        setupMQTTEvents();
    } catch (error) {
        console.error('MQTT í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
        updateConnectionStatus(false, 'MQTT ì—°ê²° ì‹¤íŒ¨');
    }
}

// MQTT ë©”ì‹œì§€ ì²˜ë¦¬ í•¨ìˆ˜
function processMessage(data) {
    console.log('ì²˜ë¦¬ ì¤‘ì¸ ë©”ì‹œì§€:', data);
    
    // ë‚™ìƒ ê°ì§€ ì²´í¬
    if (data.includes('"event":"FALL"') || data === 'FALL') {
        handleFallDetection();
        return;
    }
    
    // JSON í˜•íƒœ ë°ì´í„° íŒŒì‹±
    try {
        const jsonData = JSON.parse(data);
        if (jsonData.event === 'FALL') {
            handleFallDetection();
            return;
        }
        if (jsonData.sensor1 !== undefined &amp;amp;&amp;amp; jsonData.sensor2 !== undefined) {
            updateSensorDisplay(1, jsonData.sensor1);
            updateSensorDisplay(2, jsonData.sensor2);
            return;
        }
    } catch (e) {
        // JSONì´ ì•„ë‹Œ ê²½ìš° ë‹¤ë¥¸ íŒŒì‹± ë°©ë²• ì‹œë„
    }
    
    // ê±°ë¦¬ ë°ì´í„° íŒŒì‹±
    if (data.includes('Distance Alert!')) {
        handleDistanceAlert(data);
        parseDistanceData(data);
    } else if (data.includes('d1=') &amp;amp;&amp;amp; data.includes('d2=')) {
        parseDistanceData(data);
    } else if (data.includes('ì„¼ì„œ1') &amp;amp;&amp;amp; data.includes('ì„¼ì„œ2')) {
        parseKoreanDistanceData(data);
    }
}

// ìŒì„± ì•Œë¦¼ í•¨ìˆ˜ (Chrome ë¸Œë¼ìš°ì € í˜¸í™˜)
function speakMessage(message, priority = 'normal') {
    const currentTime = Date.now();
    
    if (priority === 'high' || currentTime - lastSpeechTime &amp;gt; speechCooldown) {
        if ('speechSynthesis' in window) {
            try {
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(message);
                const voices = window.speechSynthesis.getVoices();
                const koreanVoice = voices.find(voice =&amp;gt; 
                    voice.lang.includes('ko') || voice.lang.includes('KR')
                );
                
                if (koreanVoice) {
                    utterance.voice = koreanVoice;
                    utterance.lang = koreanVoice.lang;
                } else {
                    utterance.lang = 'ko-KR';
                }
                
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                window.speechSynthesis.speak(utterance);
                lastSpeechTime = currentTime;
                
            } catch (error) {
                console.error('ìŒì„± í•©ì„± ì˜¤ë¥˜:', error);
                showTextAlert(message);
            }
        } else {
            showTextAlert(message);
        }
    }
}

// ë‚™ìƒ ê°ì§€ ì²˜ë¦¬
function handleFallDetection() {
    fallStatus.textContent = 'ğŸš¨ ë‚™ìƒ ê°ì§€ë¨!';
    fallStatus.className = 'alert-message alert-fall';
    safetyStatus.textContent = 'ğŸš¨ ì‘ê¸‰ ìƒí™© ë°œìƒ!';
    safetyStatus.className = 'alert-message alert-fall';

    speakMessage('ê²½ê³ ! ë‚™ìƒì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì‘ê¸‰ ìƒí™©ì…ë‹ˆë‹¤.', 'high');

    setTimeout(() =&amp;gt; {
        fallStatus.textContent = 'ì •ìƒ ìƒíƒœ';
        fallStatus.className = 'alert-message alert-normal';
        updateSafetyStatus();
        speakMessage('ë‚™ìƒ ê²½ê³ ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }, 5000);
}

// ì„¼ì„œ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateSensorDisplay(sensorNum, distance) {
    console.log(`ì„¼ì„œ${sensorNum} ì—…ë°ì´íŠ¸: ${distance}cm`);
    
    if (sensorNum === 1) {
        distance1.textContent = distance + ' cm';
        updateSensorStatus(status1, distance);
    } else if (sensorNum === 2) {
        distance2.textContent = distance + ' cm';
        updateSensorStatus(status2, distance);
    }

    // ì¥ì• ë¬¼ ê°ì§€ ì²´í¬
    if (distance &amp;lt; 20) {
        triggerObstacleAlert(sensorNum, distance);
    }
}

// ì¥ì• ë¬¼ ê²½ê³  íŠ¸ë¦¬ê±°
function triggerObstacleAlert(sensorNum, distance) {
    obstacleStatus.textContent = `âš ï¸ ì„¼ì„œ${sensorNum}ì—ì„œ ì¥ì• ë¬¼ ê°ì§€! (${distance}cm)`;
    obstacleStatus.className = 'alert-message alert-obstacle';
    safetyStatus.textContent = 'âš ï¸ ì£¼ì˜ í•„ìš”';
    safetyStatus.className = 'alert-message alert-obstacle';

    speakMessage(`ì£¼ì˜! ì„¼ì„œ ${sensorNum}ì—ì„œ ${distance}ì„¼í‹°ë¯¸í„° ê±°ë¦¬ì— ì¥ì• ë¬¼ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'high');

    setTimeout(() =&amp;gt; {
        if (!obstacleStatus.className.includes('alert-obstacle')) return;
        obstacleStatus.textContent = 'ê²½ë¡œ ì•ˆì „';
        obstacleStatus.className = 'alert-message alert-normal';
        updateSafetyStatus();
        speakMessage('ì¥ì• ë¬¼ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ê²½ë¡œê°€ ì•ˆì „í•©ë‹ˆë‹¤.');
    }, 3000);
}&lt;/div&gt;
        &lt;/div&gt;

        &lt;div class="code-toggle"&gt;
            &lt;label&gt;
                &lt;input type="checkbox" id="htmlCodeToggle"&gt;
                ğŸ“„ index.html ì „ì²´ ì½”ë“œ ë³´ê¸°
            &lt;/label&gt;
        &lt;/div&gt;

        &lt;div class="arduino-code" id="htmlCode"&gt;
            &lt;div class="code-header"&gt;
                &lt;div class="code-title"&gt;ğŸ“„ index.html - ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ëª¨ë‹ˆí„°ë§ ì›¹í˜ì´ì§€&lt;/div&gt;
                &lt;button class="copy-btn" id="htmlCopyBtn"&gt;ğŸ“‹ ë³µì‚¬&lt;/button&gt;
            &lt;/div&gt;
            &lt;div class="code-content" id="htmlCodeContent"&gt;&lt;/div&gt;
        &lt;/div&gt;

        &lt;div class="connection-status connected" id="connectionStatus"&gt;âœ… MQTT ì„œë²„ ì—°ê²°ë¨&lt;/div&gt;

        &lt;div style="text-align: center; margin: 20px;"&gt;
            &lt;button onclick="testSpeech()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 16px;"&gt;
                ğŸ”Š ìŒì„± í…ŒìŠ¤íŠ¸
            &lt;/button&gt;
            &lt;small style="display: block; margin-top: 5px; color: #666;"&gt;
                ìŒì„±ì´ ì•ˆ ë“¤ë¦¬ë©´ ì´ ë²„íŠ¼ì„ ë¨¼ì € í´ë¦­í•˜ì„¸ìš”
            &lt;/small&gt;
        &lt;/div&gt;

        &lt;div class="status-panel"&gt;
            &lt;div class="card"&gt;
                &lt;div class="card-title"&gt;ğŸ“ ê±°ë¦¬ ì„¼ì„œ ë°ì´í„°&lt;/div&gt;
                &lt;div class="sensor-data"&gt;
                    &lt;span class="sensor-label"&gt;ì„¼ì„œ 1:&lt;/span&gt;
                    &lt;span class="sensor-value" id="distance1"&gt;-- cm&lt;/span&gt;
                    &lt;span class="status-indicator status-normal" id="status1"&gt;&lt;/span&gt;
                &lt;/div&gt;
                &lt;div class="sensor-data"&gt;
                    &lt;span class="sensor-label"&gt;ì„¼ì„œ 2:&lt;/span&gt;
                    &lt;span class="sensor-value" id="distance2"&gt;-- cm&lt;/span&gt;
                    &lt;span class="status-indicator status-normal" id="status2"&gt;&lt;/span&gt;
                &lt;/div&gt;
            &lt;/div&gt;

            &lt;div class="card"&gt;
                &lt;div class="card-title"&gt;ğŸš¨ ì•ˆì „ ìƒíƒœ&lt;/div&gt;
                &lt;div class="alert-message alert-normal" id="safetyStatus"&gt;
                    ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™ ì¤‘
                &lt;/div&gt;
            &lt;/div&gt;

            &lt;div class="card"&gt;
                &lt;div class="card-title"&gt;âš ï¸ ë‚™ìƒ ê°ì§€&lt;/div&gt;
                &lt;div class="alert-message alert-normal" id="fallStatus"&gt;
                    ì •ìƒ ìƒíƒœ
                &lt;/div&gt;
            &lt;/div&gt;

            &lt;div class="card"&gt;
                &lt;div class="card-title"&gt;ğŸš§ ì¥ì• ë¬¼ ê°ì§€&lt;/div&gt;
                &lt;div class="alert-message alert-normal" id="obstacleStatus"&gt;
                    ê²½ë¡œ ì•ˆì „
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class="timestamp" id="lastUpdate"&gt;
            ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: --
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;script&gt;
        const MQTT_TOPIC_SUB = 'SC_pub'; // ì•„ë‘ì´ë…¸ì—ì„œ publishí•˜ëŠ” í† í”½ì„ êµ¬ë…

        let client;
        let isConnected = false;

        // DOM ìš”ì†Œë“¤
        let connectionStatus, distance1, distance2, status1, status2;
        let safetyStatus, fallStatus, obstacleStatus, lastUpdate;

        // ìŒì„± ì•Œë¦¼ ì œì–´ ë³€ìˆ˜
        let lastSpeechTime = 0;
        let lastSensorSpeech = 0;
        const speechCooldown = 10000; // 10ì´ˆ ê°„ê²©ìœ¼ë¡œ ìŒì„± ì•Œë¦¼ ì œí•œ

        // í˜ì´ì§€ ë¡œë“œ í›„ DOM ìš”ì†Œ ì´ˆê¸°í™” ë° MQTT ì—°ê²°
        function initializeApp() {
            // DOM ìš”ì†Œë“¤ ì´ˆê¸°í™”
            connectionStatus = document.getElementById('connectionStatus');
            distance1 = document.getElementById('distance1');
            distance2 = document.getElementById('distance2');
            status1 = document.getElementById('status1');
            status2 = document.getElementById('status2');
            safetyStatus = document.getElementById('safetyStatus');
            fallStatus = document.getElementById('fallStatus');
            obstacleStatus = document.getElementById('obstacleStatus');
            lastUpdate = document.getElementById('lastUpdate');

            // MQTT ì—°ê²° (HTTPS/HTTP ìë™ ê°ì§€)
            const clientId = 'webClient_' + Math.random().toString(16).substr(2, 8);
            const isHttps = location.protocol === 'https:';
            const mqttUrl = isHttps ? 'wss://pubcode2.iptime.org:39002' : 'ws://pubcode2.iptime.org:39001';
            
            console.log('ğŸ”Œ MQTT ì—°ê²° ì‹œë„:', clientId);
            console.log('í˜„ì¬ í”„ë¡œí† ì½œ:', location.protocol);
            console.log('ì„œë²„ ì£¼ì†Œ:', mqttUrl);
            
            try {
                client = mqtt.connect(mqttUrl, {
                    clientId: clientId,
                    clean: true,
                    keepalive: 30,
                    connectTimeout: 15 * 1000,
                    reconnectPeriod: 5000,
                    protocolVersion: 4,
                    username: undefined,
                    password: undefined
                });
                
                console.log('ğŸ“¡ MQTT í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ MQTT í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
                if (isHttps) {
                    console.warn('âš ï¸ HTTPSì—ì„œ WSS ì—°ê²° ì‹¤íŒ¨ - HTTPë¡œ ì ‘ì†í•´ë³´ì„¸ìš”');
                    console.log('ğŸ”— HTTP ì£¼ì†Œ: http://poly.pubcode.kr/B03/index.html');
                    updateConnectionStatus(false, 'âŒ WSS ì—°ê²° ì‹¤íŒ¨ - HTTPë¡œ ì ‘ì†í•˜ì„¸ìš”');
                } else {
                    updateConnectionStatus(false, 'í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì‹¤íŒ¨');
                }
                return;
            }

            setupMQTTEvents();
        }

        // MQTT ì´ë²¤íŠ¸ ì„¤ì •
        function setupMQTTEvents() {
            console.log('ğŸ”§ MQTT ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì • ì¤‘...');
            console.log('ë¸Œë¼ìš°ì €:', navigator.userAgent);
            
            client.on('connect', () =&gt; {
                console.log('âœ… WebSocket MQTT ì—°ê²° ì„±ê³µ!');
                isConnected = true;
                updateConnectionStatus(true);
                client.subscribe(MQTT_TOPIC_SUB, (err) =&gt; {
                    if (err) {
                        console.error('âŒ í† í”½ êµ¬ë… ì‹¤íŒ¨:', err);
                    } else {
                        console.log('ğŸ“¡ í† í”½ êµ¬ë… ì„±ê³µ:', MQTT_TOPIC_SUB);
                        // ìŒì„± ì•Œë¦¼
                        speakMessage('ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ì‹œìŠ¤í…œì´ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤. ëª¨ë‹ˆí„°ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤.');
                    }
                });
            });

            client.on('message', (topic, message) =&gt; {
                const data = message.toString();
                console.log('ğŸ“© ìˆ˜ì‹ ëœ ë©”ì‹œì§€:', data);
                processMessage(data);
                updateTimestamp();
            });

            client.on('error', (error) =&gt; {
                console.error('âŒ MQTT ì—°ê²° ì˜¤ë¥˜:', error);
                console.error('ì˜¤ë¥˜ ìƒì„¸:', error.message);
                isConnected = false;
                updateConnectionStatus(false);
            });

            client.on('offline', () =&gt; {
                console.log('ğŸ“´ MQTT ì˜¤í”„ë¼ì¸ ìƒíƒœ');
                isConnected = false;
                updateConnectionStatus(false);
            });

            client.on('close', () =&gt; {
                console.log('ğŸ”Œ MQTT ì—°ê²° ì¢…ë£Œ');
                isConnected = false;
                updateConnectionStatus(false);
            });

            client.on('reconnect', () =&gt; {
                console.log('ğŸ”„ MQTT ì¬ì—°ê²° ì‹œë„ ì¤‘...');
            });

            client.on('disconnect', () =&gt; {
                console.log('âš ï¸ MQTT ì—°ê²° í•´ì œ');
                isConnected = false;
                updateConnectionStatus(false);
            });

            // ì—°ê²° ì‹œë„ íƒ€ì„ì•„ì›ƒ ì„¤ì • (5ì´ˆ)
            setTimeout(() =&gt; {
                if (!isConnected) {
                    console.warn('â° MQTT ì—°ê²° íƒ€ì„ì•„ì›ƒ (5ì´ˆ)');
                    if (location.protocol === 'https:') {
                        console.log('ğŸš¨ HTTPSì—ì„œ WSS ì—°ê²° ì‹¤íŒ¨!');
                        console.log('ğŸ’¡ í•´ê²° ë°©ë²•: HTTPë¡œ ì ‘ì†í•˜ì„¸ìš”');
                        console.log('ğŸ”— HTTP ì£¼ì†Œ: http://poly.pubcode.kr/B03/index.html');
                        updateConnectionStatus(false, 'âŒ WSS ì„œë²„ ì—†ìŒ - HTTPë¡œ ì ‘ì† í•„ìš”');
                        
                        // HTTP ë§í¬ë¥¼ í™”ë©´ì— í‘œì‹œ
                        showHttpLink();
                    } else {
                        console.log('ğŸ”§ ì—°ê²° ë¬¸ì œ í•´ê²° ë°©ë²•:');
                        console.log('1. ë„¤íŠ¸ì›Œí¬ ì—°ê²° í™•ì¸');
                        console.log('2. ë°©í™”ë²½ ì„¤ì • í™•ì¸');
                        console.log('3. MQTT ì„œë²„ ìƒíƒœ í™•ì¸');
                        updateConnectionStatus(false, 'ì—°ê²° íƒ€ì„ì•„ì›ƒ - ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”');
                    }
                }
            }, 5000);
        }

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(connected, customMessage = null) {
            if (connected) {
                connectionStatus.textContent = 'âœ… MQTT ì„œë²„ ì—°ê²°ë¨';
                connectionStatus.className = 'connection-status connected';
            } else {
                const message = customMessage || 'âŒ MQTT ì„œë²„ ì—°ê²° ì‹¤íŒ¨';
                connectionStatus.textContent = message;
                connectionStatus.className = 'connection-status disconnected';
            }
        }

        // ë©”ì‹œì§€ ì²˜ë¦¬
        function processMessage(data) {
            console.log('ì²˜ë¦¬ ì¤‘ì¸ ë©”ì‹œì§€:', data);
            
            // JSON í˜•íƒœ ë‚™ìƒ ì‹ í˜¸ ì²´í¬
            if (data.includes('"event":"FALL"') || data.includes("'event':'FALL'")) {
                handleFallDetection();
                return;
            }
            
            // ê¸°ì¡´ ë¬¸ìì—´ í˜•íƒœ ë‚™ìƒ ì‹ í˜¸ ì²´í¬
            if (data === 'FALL') {
                handleFallDetection();
                return;
            }
            
            // JSON í˜•íƒœ ë°ì´í„° íŒŒì‹± ì‹œë„
            try {
                const jsonData = JSON.parse(data);
                if (jsonData.event === 'FALL') {
                    handleFallDetection();
                    return;
                }
                if (jsonData.sensor1 !== undefined &amp;&amp; jsonData.sensor2 !== undefined) {
                    updateSensorDisplay(1, jsonData.sensor1);
                    updateSensorDisplay(2, jsonData.sensor2);
                    return;
                }
            } catch (e) {
                // JSONì´ ì•„ë‹Œ ê²½ìš° ê³„ì† ì§„í–‰
            }
            
            if (data.includes('Distance Alert!')) {
                handleDistanceAlert(data);
                parseDistanceData(data); // Distance Alertì—ì„œë„ ê±°ë¦¬ ë°ì´í„° íŒŒì‹±
            } else if (data.includes('d1=') &amp;&amp; data.includes('d2=')) {
                parseDistanceData(data);
            } else if (data.includes('ì„¼ì„œ1') &amp;&amp; data.includes('ì„¼ì„œ2')) {
                // "ì„¼ì„œ1 ê±°ë¦¬: 25 cm | ì„¼ì„œ2 ê±°ë¦¬: 30 cm" í˜•íƒœ íŒŒì‹±
                parseKoreanDistanceData(data);
            } else if (data.includes('ê±°ë¦¬:')) {
                // ê°œë³„ ì„¼ì„œ ë°ì´í„° íŒŒì‹±
                parseIndividualSensorData(data);
            } else {
                // ê¸°íƒ€ ìˆ«ì ë°ì´í„°ë‚˜ JSON í˜•íƒœ ì‹œë„
                tryParseNumericData(data);
            }
        }

        // ìŒì„± ì•Œë¦¼ í•¨ìˆ˜ (í¬ë¡¬ HTTP í˜¸í™˜ì„± ê°œì„ )
        function speakMessage(message, priority = 'normal') {
            const currentTime = Date.now();
            
            // ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ ê²½ìš° (ë‚™ìƒ, ì¥ì• ë¬¼) ì¦‰ì‹œ ì¬ìƒ
            if (priority === 'high' || currentTime - lastSpeechTime &gt; speechCooldown) {
                if ('speechSynthesis' in window) {
                    try {
                        // ê¸°ì¡´ ìŒì„± ì •ì§€
                        window.speechSynthesis.cancel();
                        
                        // í¬ë¡¬ì—ì„œ ìŒì„± ëª©ë¡ ë¡œë“œ ëŒ€ê¸°
                        const voices = window.speechSynthesis.getVoices();
                        
                        const utterance = new SpeechSynthesisUtterance(message);
                        
                        // í•œêµ­ì–´ ìŒì„± ì°¾ê¸°
                        const koreanVoice = voices.find(voice =&gt; 
                            voice.lang.includes('ko') || voice.lang.includes('KR')
                        );
                        
                        if (koreanVoice) {
                            utterance.voice = koreanVoice;
                            utterance.lang = koreanVoice.lang;
                        } else {
                            utterance.lang = 'ko-KR';
                        }
                        
                        utterance.rate = 0.9;
                        utterance.pitch = 1.0;
                        utterance.volume = 1.0;
                        
                        // í¬ë¡¬ HTTPì—ì„œ ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ì—†ì´ ì¬ìƒ ì‹œë„
                        const playPromise = new Promise((resolve) =&gt; {
                            utterance.onstart = () =&gt; {
                                console.log('ğŸ”Š ìŒì„± ì¬ìƒ ì‹œì‘:', message);
                                resolve();
                            };
                            utterance.onerror = (event) =&gt; {
                                console.warn('ğŸ”‡ ìŒì„± ì¬ìƒ ì‹¤íŒ¨:', event.error);
                                console.log('ğŸ’¡ í•´ê²° ë°©ë²•: í˜ì´ì§€ë¥¼ í´ë¦­í•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
                                resolve();
                            };
                            utterance.onend = () =&gt; {
                                console.log('ğŸ”Š ìŒì„± ì¬ìƒ ì™„ë£Œ');
                            };
                        });
                        
                        window.speechSynthesis.speak(utterance);
                        console.log('ğŸ”Š ìŒì„± ì•Œë¦¼ ìš”ì²­:', message);
                        
                        lastSpeechTime = currentTime;
                        
                    } catch (error) {
                        console.error('ğŸ”‡ ìŒì„± í•©ì„± ì˜¤ë¥˜:', error);
                        showTextAlert(message); // ëŒ€ì²´ í…ìŠ¤íŠ¸ ì•Œë¦¼
                    }
                } else {
                    console.warn('ğŸ”‡ ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    showTextAlert(message); // ëŒ€ì²´ í…ìŠ¤íŠ¸ ì•Œë¦¼
                }
            } else {
                console.log('ğŸ”‡ ìŒì„± ì•Œë¦¼ ìŠ¤í‚µ (ì¿¨ë‹¤ìš´):', message);
            }
        }

        // ìŒì„±ì´ ì•ˆ ë  ë•Œ ëŒ€ì²´ í…ìŠ¤íŠ¸ ì•Œë¦¼
        function showTextAlert(message) {
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #ff4444;
                color: white;
                padding: 20px;
                border-radius: 10px;
                font-size: 18px;
                font-weight: bold;
                z-index: 2000;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                max-width: 80%;
                text-align: center;
            `;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            // 3ì´ˆ í›„ ì œê±°
            setTimeout(() =&gt; {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // ìŒì„± ê¶Œí•œ ìš”ì²­ ë° ì´ˆê¸°í™”
        function initializeSpeech() {
            if ('speechSynthesis' in window) {
                // í¬ë¡¬ì—ì„œ ìŒì„± ëª©ë¡ ë¡œë“œ ëŒ€ê¸°
                const loadVoices = () =&gt; {
                    const voices = window.speechSynthesis.getVoices();
                    console.log('ğŸ¤ ì‚¬ìš© ê°€ëŠ¥í•œ ìŒì„±:', voices.length, 'ê°œ');
                    
                    const koreanVoices = voices.filter(voice =&gt; 
                        voice.lang.includes('ko') || voice.lang.includes('KR')
                    );
                    console.log('ğŸ‡°ğŸ‡· í•œêµ­ì–´ ìŒì„±:', koreanVoices.length, 'ê°œ');
                    
                    if (koreanVoices.length &gt; 0) {
                        console.log('âœ… í•œêµ­ì–´ ìŒì„± ì‚¬ìš© ê°€ëŠ¥');
                    } else {
                        console.warn('âš ï¸ í•œêµ­ì–´ ìŒì„±ì´ ì—†ì–´ ê¸°ë³¸ ìŒì„±ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                    }
                };

                // ìŒì„± ëª©ë¡ì´ ë¡œë“œë˜ë©´ ì‹¤í–‰
                if (window.speechSynthesis.getVoices().length &gt; 0) {
                    loadVoices();
                } else {
                    window.speechSynthesis.onvoiceschanged = loadVoices;
                }
                
                // ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ìœ¼ë¡œ ìŒì„± ê¶Œí•œ í™œì„±í™”
                document.addEventListener('click', function enableSpeech() {
                    const testUtterance = new SpeechSynthesisUtterance('');
                    window.speechSynthesis.speak(testUtterance);
                    window.speechSynthesis.cancel();
                    console.log('ğŸ”Š ìŒì„± ê¶Œí•œ í™œì„±í™”ë¨');
                    document.removeEventListener('click', enableSpeech);
                }, { once: true });
            }
        }

        // ë‚™ìƒ ê°ì§€ ì²˜ë¦¬
        function handleFallDetection() {
            fallStatus.textContent = 'ğŸš¨ ë‚™ìƒ ê°ì§€ë¨!';
            fallStatus.className = 'alert-message alert-fall';
            safetyStatus.textContent = 'ğŸš¨ ì‘ê¸‰ ìƒí™© ë°œìƒ!';
            safetyStatus.className = 'alert-message alert-fall';

            // ìŒì„± ì•Œë¦¼ (ë†’ì€ ìš°ì„ ìˆœìœ„)
            speakMessage('ê²½ê³ ! ë‚™ìƒì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì‘ê¸‰ ìƒí™©ì…ë‹ˆë‹¤.', 'high');

            // 5ì´ˆ í›„ ì •ìƒ ìƒíƒœë¡œ ë³µê·€
            setTimeout(() =&gt; {
                fallStatus.textContent = 'ì •ìƒ ìƒíƒœ';
                fallStatus.className = 'alert-message alert-normal';
                updateSafetyStatus();
                speakMessage('ë‚™ìƒ ê²½ê³ ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }, 5000);
        }

        // ê±°ë¦¬ ê²½ê³  ì²˜ë¦¬
        function handleDistanceAlert(data) {
            obstacleStatus.textContent = 'âš ï¸ ì¥ì• ë¬¼ ê°ì§€! (20cm ë¯¸ë§Œ)';
            obstacleStatus.className = 'alert-message alert-obstacle';
            safetyStatus.textContent = 'âš ï¸ ì£¼ì˜ í•„ìš”';
            safetyStatus.className = 'alert-message alert-obstacle';

            // ìŒì„± ì•Œë¦¼ (ë†’ì€ ìš°ì„ ìˆœìœ„)
            speakMessage('ì£¼ì˜! ì¥ì• ë¬¼ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'high');

            // 3ì´ˆ í›„ ì •ìƒ ìƒíƒœë¡œ ë³µê·€
            setTimeout(() =&gt; {
                obstacleStatus.textContent = 'ê²½ë¡œ ì•ˆì „';
                obstacleStatus.className = 'alert-message alert-normal';
                updateSafetyStatus();
                speakMessage('ì¥ì• ë¬¼ ê²½ê³ ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ê²½ë¡œê°€ ì•ˆì „í•©ë‹ˆë‹¤.');
            }, 3000);
        }

        // ê±°ë¦¬ ë°ì´í„° íŒŒì‹± (d1=25, d2=30 í˜•íƒœ)
        function parseDistanceData(data) {
            const d1Match = data.match(/d1=(\d+)/);
            const d2Match = data.match(/d2=(\d+)/);

            if (d1Match) {
                const dist1 = parseInt(d1Match[1]);
                updateSensorDisplay(1, dist1);
            }

            if (d2Match) {
                const dist2 = parseInt(d2Match[1]);
                updateSensorDisplay(2, dist2);
            }
        }

        // í•œêµ­ì–´ ê±°ë¦¬ ë°ì´í„° íŒŒì‹± ("ì„¼ì„œ1 ê±°ë¦¬: 25 cm | ì„¼ì„œ2 ê±°ë¦¬: 30 cm" í˜•íƒœ)
        function parseKoreanDistanceData(data) {
            const sensor1Match = data.match(/ì„¼ì„œ1\s*ê±°ë¦¬:\s*(\d+)\s*cm/);
            const sensor2Match = data.match(/ì„¼ì„œ2\s*ê±°ë¦¬:\s*(\d+)\s*cm/);

            if (sensor1Match) {
                const dist1 = parseInt(sensor1Match[1]);
                updateSensorDisplay(1, dist1);
            }

            if (sensor2Match) {
                const dist2 = parseInt(sensor2Match[1]);
                updateSensorDisplay(2, dist2);
            }
        }

        // ê°œë³„ ì„¼ì„œ ë°ì´í„° íŒŒì‹±
        function parseIndividualSensorData(data) {
            // "ê±°ë¦¬: 25" ë˜ëŠ” "Distance: 25" í˜•íƒœ
            const distMatch = data.match(/ê±°ë¦¬:\s*(\d+)/);
            if (distMatch) {
                const distance = parseInt(distMatch[1]);
                // ë§ˆì§€ë§‰ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•  ì„¼ì„œ ê²°ì • (êµëŒ€ë¡œ ì—…ë°ì´íŠ¸)
                const currentTime = Date.now();
                const sensorNum = Math.floor(currentTime / 1000) % 2 + 1;
                updateSensorDisplay(sensorNum, distance);
            }
        }

        // ìˆ«ì ë°ì´í„° ì‹œë„ íŒŒì‹±
        function tryParseNumericData(data) {
            // JSON í˜•íƒœ ì‹œë„
            try {
                const jsonData = JSON.parse(data);
                if (jsonData.sensor1 !== undefined) {
                    updateSensorDisplay(1, jsonData.sensor1);
                }
                if (jsonData.sensor2 !== undefined) {
                    updateSensorDisplay(2, jsonData.sensor2);
                }
                return;
            } catch (e) {
                // JSONì´ ì•„ë‹˜
            }

            // ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ë‘ ìˆ«ì ì‹œë„ "25,30"
            const csvMatch = data.match(/^(\d+),(\d+)$/);
            if (csvMatch) {
                updateSensorDisplay(1, parseInt(csvMatch[1]));
                updateSensorDisplay(2, parseInt(csvMatch[2]));
                return;
            }

            // ë‹¨ìˆœ ìˆ«ì í•˜ë‚˜ë§Œ ìˆëŠ” ê²½ìš°
            const numMatch = data.match(/^\d+$/);
            if (numMatch) {
                const distance = parseInt(data);
                // êµëŒ€ë¡œ ì„¼ì„œì— í• ë‹¹
                const sensorNum = Math.floor(Date.now() / 1000) % 2 + 1;
                updateSensorDisplay(sensorNum, distance);
            }
        }

        // ì„¼ì„œ í‘œì‹œ ì—…ë°ì´íŠ¸ (í†µí•© í•¨ìˆ˜)
        function updateSensorDisplay(sensorNum, distance) {
            console.log(`ì„¼ì„œ${sensorNum} ì—…ë°ì´íŠ¸: ${distance}cm`);
            
            if (sensorNum === 1) {
                distance1.textContent = distance + ' cm';
                updateSensorStatus(status1, distance);
            } else if (sensorNum === 2) {
                distance2.textContent = distance + ' cm';
                updateSensorStatus(status2, distance);
            }

            // ì¥ì• ë¬¼ ê°ì§€ ì²´í¬
            if (distance &lt; 20) {
                triggerObstacleAlert(sensorNum, distance);
            } else {
                // ì •ìƒ ìƒíƒœì¼ ë•Œ 30ì´ˆë§ˆë‹¤ ìƒíƒœ ì•Œë¦¼
                const currentTime = Date.now();
                if (currentTime - lastSensorSpeech &gt; 30000) {
                    speakMessage(`ì„¼ì„œê°€ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤. ì „ë°© ê²½ë¡œê°€ ì•ˆì „í•©ë‹ˆë‹¤.`);
                    lastSensorSpeech = currentTime;
                }
            }
        }

        // ì¥ì• ë¬¼ ê²½ê³  íŠ¸ë¦¬ê±°
        function triggerObstacleAlert(sensorNum, distance) {
            console.log(`ì¥ì• ë¬¼ ê°ì§€! ì„¼ì„œ${sensorNum}: ${distance}cm`);
            obstacleStatus.textContent = `âš ï¸ ì„¼ì„œ${sensorNum}ì—ì„œ ì¥ì• ë¬¼ ê°ì§€! (${distance}cm)`;
            obstacleStatus.className = 'alert-message alert-obstacle';
            safetyStatus.textContent = 'âš ï¸ ì£¼ì˜ í•„ìš”';
            safetyStatus.className = 'alert-message alert-obstacle';

            // ìŒì„± ì•Œë¦¼ (ì„¼ì„œë³„ êµ¬ë¶„, ë†’ì€ ìš°ì„ ìˆœìœ„)
            speakMessage(`ì£¼ì˜! ì„¼ì„œ ${sensorNum}ì—ì„œ ${distance}ì„¼í‹°ë¯¸í„° ê±°ë¦¬ì— ì¥ì• ë¬¼ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'high');

            // 3ì´ˆ í›„ ì •ìƒ ìƒíƒœë¡œ ë³µê·€
            setTimeout(() =&gt; {
                if (!obstacleStatus.className.includes('alert-obstacle')) return;
                obstacleStatus.textContent = 'ê²½ë¡œ ì•ˆì „';
                obstacleStatus.className = 'alert-message alert-normal';
                updateSafetyStatus();
                speakMessage('ì¥ì• ë¬¼ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ê²½ë¡œê°€ ì•ˆì „í•©ë‹ˆë‹¤.');
            }, 3000);
        }

        // ì„¼ì„œ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSensorStatus(statusElement, distance) {
            if (distance &lt; 20) {
                statusElement.className = 'status-indicator status-danger';
            } else if (distance &lt; 50) {
                statusElement.className = 'status-indicator status-warning';
            } else {
                statusElement.className = 'status-indicator status-normal';
            }
        }

        // ì „ì²´ ì•ˆì „ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSafetyStatus() {
            if (fallStatus.className.includes('alert-fall') || 
                obstacleStatus.className.includes('alert-obstacle')) {
                return; // ì´ë¯¸ ê²½ê³  ìƒíƒœë©´ ë³€ê²½í•˜ì§€ ì•ŠìŒ
            }

            safetyStatus.textContent = 'âœ… ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™ ì¤‘';
            safetyStatus.className = 'alert-message alert-normal';
        }

        // íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸
        function updateTimestamp() {
            const now = new Date();
            lastUpdate.textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${now.toLocaleString('ko-KR')}`;
        }

        // HTTP ë§í¬ í‘œì‹œ
        function showHttpLink() {
            const linkDiv = document.createElement('div');
            linkDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #dc3545;
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 1000;
                text-align: center;
                font-weight: bold;
            `;
            linkDiv.innerHTML = `
                ğŸš¨ HTTPSì—ì„œ MQTT ì—°ê²° ë¶ˆê°€&lt;br&gt;
                &lt;a href="http://poly.pubcode.kr/B03/index.html" 
                   style="color: #fff3cd; text-decoration: underline;"&gt;
                   HTTP ë²„ì „ìœ¼ë¡œ ì´ë™í•˜ê¸°
                &lt;/a&gt;
                &lt;button onclick="this.parentElement.remove()" 
                        style="margin-left: 10px; background: none; border: 1px solid white; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer;"&gt;
                   ë‹«ê¸°
                &lt;/button&gt;
            `;
            document.body.appendChild(linkDiv);
            
            // 10ì´ˆ í›„ ìë™ìœ¼ë¡œ ì œê±°
            setTimeout(() =&gt; {
                if (linkDiv.parentElement) {
                    linkDiv.remove();
                }
            }, 10000);
        }

        // Arduino UNO R4 WIFI ì½”ë“œ (ìµœì‹  ì—…ë°ì´íŠ¸)
        const arduinoCode = `#include &lt;Arduino.h&gt;
#include &lt;WiFiS3.h&gt;         // UNO R4 WiFi ìš©
#include &lt;PubSubClient.h&gt;   // MQTT ë¼ì´ë¸ŒëŸ¬ë¦¬

#define RX_BAUD 9600

// WiFi ì •ë³´
const char* ssid = "SmartCenter 2.4G";
const char* password = "12345678";

// MQTT ì„œë²„ ì •ë³´
const char* mqtt_server = "pubcode2.iptime.org";
const int mqtt_port = 31883;
const char* mqtt_topic_sub = "SC_sub";
const char* mqtt_topic_pub = "SC_pub";

WiFiClient espClient;
PubSubClient client(espClient);

// HC-SR04 ì„¼ì„œ1, ì„¼ì„œ2 í•€
#define TRIG1 5
#define ECHO1 4
#define TRIG2 2
#define ECHO2 3

// ì§„ë™ ëª¨í„°
#define VIBRATION_MOTOR 8
bool vibrationOn = false;

// ë²„ì €
#define BUZZER_PIN 9

// ê±°ë¦¬ì„¼ì„œ ê°’ ì£¼ê¸°ì  ì „ì†¡ìš©
unsigned long lastSendTime = 0;
const unsigned long sendInterval = 1000; // 1ì´ˆë§ˆë‹¤ ì „ì†¡

// ìŒê³„ ì •ì˜ (ìŠˆí¼ë§ˆë¦¬ì˜¤ í…Œë§ˆìš©)
#define NOTE_E4 330
#define NOTE_F4 349
#define NOTE_G4 392
#define NOTE_A4 440
#define NOTE_AS4 466
#define NOTE_B4 494
#define NOTE_C5 523
#define NOTE_D5 587
#define NOTE_E5 659
#define NOTE_F5 698
#define NOTE_G5 784
#define NOTE_A5 880

// ìŠˆí¼ë§ˆë¦¬ì˜¤ í…Œë§ˆ (ì§§ì€ ë²„ì „)
int marioMelody[] = {
  NOTE_E5, NOTE_E5, 0, NOTE_E5,
  0, NOTE_C5, NOTE_E5, 0,
  NOTE_G5, 0, 0,  0,
  NOTE_G4, 0, 0, 0,

  NOTE_C5, 0, 0, NOTE_G4,
  0, 0, NOTE_E4, 0,
  0, NOTE_A4, 0, NOTE_B4,
  0, NOTE_AS4, NOTE_A4, 0,

  NOTE_G4, NOTE_E5, NOTE_G5,
  NOTE_A5, 0, NOTE_F5, NOTE_G5,
  0, NOTE_E5, 0, NOTE_C5,
  NOTE_D5, NOTE_B4, 0, 0
};

int marioDurations[] = {
  150, 150, 150, 150,
  150, 150, 150, 150,
  150, 150, 150, 150,
  150, 150, 150, 150,

  150, 150, 150, 150,
  150, 150, 150, 150,
  150, 150, 150, 150,
  150, 150, 150, 150,

  150, 150, 150,
  150, 150, 150, 150,
  150, 150, 150, 150,
  150, 150, 150, 150
};

int marioLength = sizeof(marioMelody) / sizeof(int);

// ì´ˆìŒíŒŒ ê±°ë¦¬ ì¸¡ì • í•¨ìˆ˜
long getDistance(int trigPin, int echoPin) {
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);

  long duration = pulseIn(echoPin, HIGH, 20000); // íƒ€ì„ì•„ì›ƒ 20ms
  if (duration == 0) return 999; // ì¸¡ì • ì‹¤íŒ¨ì‹œ í° ê°’ ë°˜í™˜
  long distance = duration * 0.034 / 2;  // cm
  return distance;
}

// ìŠˆí¼ë§ˆë¦¬ì˜¤ ë©œë¡œë”” ì—°ì£¼
void playMario() {
  for (int i = 0; i &lt; marioLength; i++) {
    int noteDuration = marioDurations[i];
    if (marioMelody[i] == 0) {
      noTone(BUZZER_PIN);
    } else {
      tone(BUZZER_PIN, marioMelody[i], noteDuration);
    }
    delay(noteDuration * 1.3);
  }
  noTone(BUZZER_PIN);
}

// MQTT ì¬ì—°ê²°
void reconnect() {
  while (!client.connected()) {
    Serial.print("MQTT ì—°ê²° ì‹œë„...");
    if (client.connect("ArduinoWiFiClient")) {
      Serial.println("ì—°ê²°ë¨");
      client.subscribe(mqtt_topic_sub);
    } else {
      Serial.print("ì‹¤íŒ¨, rc=");
      Serial.print(client.state());
      Serial.println(" 5ì´ˆ í›„ ì¬ì‹œë„");
      delay(5000);
    }
  }
}

void setup() {
  Serial.begin(9600);

  // ì´ˆìŒíŒŒ í•€ ëª¨ë“œ ì„¤ì •
  pinMode(TRIG1, OUTPUT);
  pinMode(ECHO1, INPUT);
  pinMode(TRIG2, OUTPUT);
  pinMode(ECHO2, INPUT);

  // ì§„ë™ëª¨í„° + ë²„ì € í•€
  pinMode(VIBRATION_MOTOR, OUTPUT);
  pinMode(BUZZER_PIN, OUTPUT);
  digitalWrite(VIBRATION_MOTOR, LOW);

  Serial1.begin(RX_BAUD); // Nano 33 TX â†” WiFi RX ì—°ê²°
  delay(2000);

  // WiFi ì—°ê²°
  Serial.print("WiFi ì—°ê²° ì¤‘: ");
  Serial.println(ssid);
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.print(".");
  }
  Serial.println("\nWiFi ì—°ê²° ì„±ê³µ!");
  Serial.print("IP ì£¼ì†Œ: ");
  Serial.println(WiFi.localIP());

  // MQTT ì„¤ì •
  client.setServer(mqtt_server, mqtt_port);

  Serial.println("HC-SR04 / Vibration Motor / Buzzer (Super Mario) ì‹œì‘");
  Serial.println("WiFi ë³´ë“œ - ë‚™ìƒ ì‹ í˜¸ ìˆ˜ì‹  ëŒ€ê¸° ì¤‘...");
}

void loop() {
  if (!client.connected()) {
    reconnect();
  }
  client.loop();

  // ì´ˆìŒíŒŒ ì„¼ì„œ ê°’ ì½ê¸°
  long dist1 = getDistance(TRIG1, ECHO1);
  long dist2 = getDistance(TRIG2, ECHO2);

  Serial.print("ì„¼ì„œ1 ê±°ë¦¬: ");
  Serial.print(dist1);
  Serial.print(" cm | ì„¼ì„œ2 ê±°ë¦¬: ");
  Serial.print(dist2);
  Serial.println(" cm");

  // ì£¼ê¸°ì ìœ¼ë¡œ ê±°ë¦¬ê°’ MQTT ì „ì†¡
  unsigned long now = millis();
  if (now - lastSendTime &gt; sendInterval) {
    lastSendTime = now;
    char msg[100];
    sprintf(msg, "{\\"sensor1\\":%ld, \\"sensor2\\":%ld}", dist1, dist2);
    client.publish(mqtt_topic_pub, msg);
    Serial.print("MQTT ì „ì†¡: ");
    Serial.println(msg);
  }

  // ë‚™ìƒ ì‹ í˜¸ ìˆ˜ì‹  ì²˜ë¦¬
  if (Serial1.available()) {
    String data = Serial1.readStringUntil('\\n');
    data.trim();
    Serial.println(data);
    if (data == "FALL") {
      Serial.println("&gt;&gt;&gt; ë‚™ìƒ ì‹ í˜¸ ìˆ˜ì‹ ë¨!");
      client.publish(mqtt_topic_pub, "{\\"event\\":\\"FALL\\"}");
    }
  }

  // ===== ê±°ë¦¬ ì¡°ê±´ìœ¼ë¡œ ìë™ ì œì–´ =====
  if (dist1 &lt; 20 || dist2 &lt; 20) {
    if (!vibrationOn) {
      vibrationOn = true;
      Serial.println("ê±°ë¦¬ &lt; 20cm â†’ ì§„ë™ëª¨í„° ON (1ì´ˆ) + ë§ˆë¦¬ì˜¤ í…Œë§ˆ");
      digitalWrite(VIBRATION_MOTOR, HIGH);
      delay(1000);
      digitalWrite(VIBRATION_MOTOR, LOW);

      // ì¦‰ì‹œ MQTT ê²½ê³  ì „ì†¡
      char alertMsg[100];
      sprintf(alertMsg, "{\\"alert\\":\\"distance&lt;20\\", \\"sensor1\\":%ld, \\"sensor2\\":%ld}", dist1, dist2);
      client.publish(mqtt_topic_pub, alertMsg);
      
      playMario();
    }
  } else {
    if (vibrationOn) {
      vibrationOn = false;
      Serial.println("ê±°ë¦¬ &gt;= 20cm â†’ ì§„ë™ëª¨í„° OFF + ë²„ì € OFF");
      digitalWrite(VIBRATION_MOTOR, LOW);
      noTone(BUZZER_PIN);
    }
  }

  delay(300);
}`;

        // ì½”ë“œ í† ê¸€ ê¸°ëŠ¥
        function toggleCodeDisplay() {
            const codeToggle = document.getElementById('codeToggle');
            const arduinoCodeDiv = document.getElementById('arduinoCode');
            const codeContent = document.getElementById('codeContent');

            if (codeToggle.checked) {
                codeContent.textContent = arduinoCode;
                arduinoCodeDiv.classList.add('show');
            } else {
                arduinoCodeDiv.classList.remove('show');
            }
        }

        // ì½”ë“œ ë³µì‚¬ ê¸°ëŠ¥
        function copyCode() {
            const copyBtn = document.getElementById('copyBtn');
            
            navigator.clipboard.writeText(arduinoCode).then(() =&gt; {
                copyBtn.textContent = 'âœ… ë³µì‚¬ë¨!';
                copyBtn.classList.add('copied');
                
                setTimeout(() =&gt; {
                    copyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                    copyBtn.classList.remove('copied');
                }, 2000);
            }).catch(err =&gt; {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                copyBtn.textContent = 'âŒ ì‹¤íŒ¨';
                setTimeout(() =&gt; {
                    copyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                }, 2000);
            });
        }

        // Arduino Nano 33 BLE ì½”ë“œ
        const nanoArduinoCode = `#include &lt;Arduino_LSM9DS1.h&gt;  // Nano 33 Sense Rev2 IMU ë¼ì´ë¸ŒëŸ¬ë¦¬

#define THRESHOLD 4   // g ë‹¨ìœ„, 2.5g ì´ìƒ ê¸‰ê²©í•œ ë³€í™”ë©´ ë‚™ìƒìœ¼ë¡œ íŒë‹¨
#define TX_BAUD 9600

void setup() {
  Serial.begin(9600);     // PC ëª¨ë‹ˆí„°ë§ìš©
  Serial1.begin(TX_BAUD); // ë‹¤ë¥¸ ì•„ë‘ì´ë…¸ë¡œ ì „ì†¡ (TX=Nano D1, RX=ìƒëŒ€ë³´ë“œ RXí•€)
  
  if (!IMU.begin()) {
    Serial.println("IMU ì´ˆê¸°í™” ì‹¤íŒ¨!");
    while (1);
  }
  Serial.println("IMU ì‹œì‘ - ë‚™ìƒ ê°ì§€ ëŒ€ê¸° ì¤‘...");
}

void loop() {
  float x, y, z;

  if (IMU.accelerationAvailable()) {
    IMU.readAcceleration(x, y, z);

    float magnitude = sqrt(x * x + y * y + z * z); // ê°€ì†ë„ í¬ê¸° (g ë‹¨ìœ„)

    if (magnitude &gt; 3) {
       Serial.println(magnitude);
    }

    if (magnitude &gt; THRESHOLD) {
      Serial.println("ë‚™ìƒ ê°ì§€!");
      Serial1.println("FALL");   // ë‹¤ë¥¸ ë³´ë“œë¡œ ë‚™ìƒ ì‹ í˜¸ ì „ì†¡
      delay(1000);               // ì¤‘ë³µ ê°ì§€ ë°©ì§€
    }
  } 
}`;

        // ì½”ë“œ í† ê¸€ ê¸°ëŠ¥ (Nano 33 BLE)
        function toggleNanoCodeDisplay() {
            const nanoCodeToggle = document.getElementById('nanoCodeToggle');
            const nanoArduinoCodeDiv = document.getElementById('nanoArduinoCode');
            const nanoCodeContent = document.getElementById('nanoCodeContent');

            if (nanoCodeToggle.checked) {
                nanoCodeContent.textContent = nanoArduinoCode;
                nanoArduinoCodeDiv.classList.add('show');
            } else {
                nanoArduinoCodeDiv.classList.remove('show');
            }
        }

        // ì½”ë“œ ë³µì‚¬ ê¸°ëŠ¥ (Nano 33 BLE)
        function copyNanoCode() {
            const nanoCopyBtn = document.getElementById('nanoCopyBtn');
            
            navigator.clipboard.writeText(nanoArduinoCode).then(() =&gt; {
                nanoCopyBtn.textContent = 'âœ… ë³µì‚¬ë¨!';
                nanoCopyBtn.classList.add('copied');
                
                setTimeout(() =&gt; {
                    nanoCopyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                    nanoCopyBtn.classList.remove('copied');
                }, 2000);
            }).catch(err =&gt; {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                nanoCopyBtn.textContent = 'âŒ ì‹¤íŒ¨';
                setTimeout(() =&gt; {
                    nanoCopyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                }, 2000);
            });
        }

        // ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ëª¨ë‹ˆí„°ë§ ì½”ë“œ (JavaScript ë¶€ë¶„)
        const monitoringCode = `// ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ - JavaScript Core Functions

// MQTT ì—°ê²° ë° ë©”ì‹œì§€ ì²˜ë¦¬
const MQTT_TOPIC_SUB = 'SC_pub';
let client;
let isConnected = false;

// ìŒì„± ì•Œë¦¼ ì œì–´ ë³€ìˆ˜
let lastSpeechTime = 0;
let lastSensorSpeech = 0;
const speechCooldown = 10000; // 10ì´ˆ ê°„ê²©

// ì•± ì´ˆê¸°í™” í•¨ìˆ˜
function initializeApp() {
    // DOM ìš”ì†Œë“¤ ì´ˆê¸°í™”
    connectionStatus = document.getElementById('connectionStatus');
    distance1 = document.getElementById('distance1');
    distance2 = document.getElementById('distance2');
    status1 = document.getElementById('status1');
    status2 = document.getElementById('status2');
    safetyStatus = document.getElementById('safetyStatus');
    fallStatus = document.getElementById('fallStatus');
    obstacleStatus = document.getElementById('obstacleStatus');
    lastUpdate = document.getElementById('lastUpdate');

    // MQTT ì—°ê²° ì„¤ì •
    const clientId = 'webClient_' + Math.random().toString(16).substr(2, 8);
    const isHttps = location.protocol === 'https:';
    const mqttUrl = isHttps ? 'wss://pubcode2.iptime.org:39002' : 'ws://pubcode2.iptime.org:39001';
    
    try {
        client = mqtt.connect(mqttUrl, {
            clientId: clientId,
            clean: true,
            keepalive: 30,
            connectTimeout: 15 * 1000,
            reconnectPeriod: 5000,
            protocolVersion: 4
        });
        setupMQTTEvents();
    } catch (error) {
        console.error('MQTT í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
        updateConnectionStatus(false, 'MQTT ì—°ê²° ì‹¤íŒ¨');
    }
}

// MQTT ë©”ì‹œì§€ ì²˜ë¦¬ í•¨ìˆ˜
function processMessage(data) {
    console.log('ì²˜ë¦¬ ì¤‘ì¸ ë©”ì‹œì§€:', data);
    
    // ë‚™ìƒ ê°ì§€ ì²´í¬
    if (data.includes('"event":"FALL"') || data === 'FALL') {
        handleFallDetection();
        return;
    }
    
    // JSON í˜•íƒœ ë°ì´í„° íŒŒì‹±
    try {
        const jsonData = JSON.parse(data);
        if (jsonData.event === 'FALL') {
            handleFallDetection();
            return;
        }
        if (jsonData.sensor1 !== undefined &amp;&amp; jsonData.sensor2 !== undefined) {
            updateSensorDisplay(1, jsonData.sensor1);
            updateSensorDisplay(2, jsonData.sensor2);
            return;
        }
    } catch (e) {
        // JSONì´ ì•„ë‹Œ ê²½ìš° ë‹¤ë¥¸ íŒŒì‹± ë°©ë²• ì‹œë„
    }
    
    // ê±°ë¦¬ ë°ì´í„° íŒŒì‹±
    if (data.includes('Distance Alert!')) {
        handleDistanceAlert(data);
        parseDistanceData(data);
    } else if (data.includes('d1=') &amp;&amp; data.includes('d2=')) {
        parseDistanceData(data);
    } else if (data.includes('ì„¼ì„œ1') &amp;&amp; data.includes('ì„¼ì„œ2')) {
        parseKoreanDistanceData(data);
    }
}

// ìŒì„± ì•Œë¦¼ í•¨ìˆ˜ (Chrome ë¸Œë¼ìš°ì € í˜¸í™˜)
function speakMessage(message, priority = 'normal') {
    const currentTime = Date.now();
    
    if (priority === 'high' || currentTime - lastSpeechTime &gt; speechCooldown) {
        if ('speechSynthesis' in window) {
            try {
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(message);
                const voices = window.speechSynthesis.getVoices();
                const koreanVoice = voices.find(voice =&gt; 
                    voice.lang.includes('ko') || voice.lang.includes('KR')
                );
                
                if (koreanVoice) {
                    utterance.voice = koreanVoice;
                    utterance.lang = koreanVoice.lang;
                } else {
                    utterance.lang = 'ko-KR';
                }
                
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                window.speechSynthesis.speak(utterance);
                lastSpeechTime = currentTime;
                
            } catch (error) {
                console.error('ìŒì„± í•©ì„± ì˜¤ë¥˜:', error);
                showTextAlert(message);
            }
        } else {
            showTextAlert(message);
        }
    }
}

// ë‚™ìƒ ê°ì§€ ì²˜ë¦¬
function handleFallDetection() {
    fallStatus.textContent = 'ğŸš¨ ë‚™ìƒ ê°ì§€ë¨!';
    fallStatus.className = 'alert-message alert-fall';
    safetyStatus.textContent = 'ğŸš¨ ì‘ê¸‰ ìƒí™© ë°œìƒ!';
    safetyStatus.className = 'alert-message alert-fall';

    speakMessage('ê²½ê³ ! ë‚™ìƒì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì‘ê¸‰ ìƒí™©ì…ë‹ˆë‹¤.', 'high');

    setTimeout(() =&gt; {
        fallStatus.textContent = 'ì •ìƒ ìƒíƒœ';
        fallStatus.className = 'alert-message alert-normal';
        updateSafetyStatus();
        speakMessage('ë‚™ìƒ ê²½ê³ ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }, 5000);
}

// ì„¼ì„œ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateSensorDisplay(sensorNum, distance) {
    console.log(\`ì„¼ì„œ\${sensorNum} ì—…ë°ì´íŠ¸: \${distance}cm\`);
    
    if (sensorNum === 1) {
        distance1.textContent = distance + ' cm';
        updateSensorStatus(status1, distance);
    } else if (sensorNum === 2) {
        distance2.textContent = distance + ' cm';
        updateSensorStatus(status2, distance);
    }

    // ì¥ì• ë¬¼ ê°ì§€ ì²´í¬
    if (distance &lt; 20) {
        triggerObstacleAlert(sensorNum, distance);
    }
}

// ì¥ì• ë¬¼ ê²½ê³  íŠ¸ë¦¬ê±°
function triggerObstacleAlert(sensorNum, distance) {
    obstacleStatus.textContent = \`âš ï¸ ì„¼ì„œ\${sensorNum}ì—ì„œ ì¥ì• ë¬¼ ê°ì§€! (\${distance}cm)\`;
    obstacleStatus.className = 'alert-message alert-obstacle';
    safetyStatus.textContent = 'âš ï¸ ì£¼ì˜ í•„ìš”';
    safetyStatus.className = 'alert-message alert-obstacle';

    speakMessage(\`ì£¼ì˜! ì„¼ì„œ \${sensorNum}ì—ì„œ \${distance}ì„¼í‹°ë¯¸í„° ê±°ë¦¬ì— ì¥ì• ë¬¼ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\`, 'high');

    setTimeout(() =&gt; {
        if (!obstacleStatus.className.includes('alert-obstacle')) return;
        obstacleStatus.textContent = 'ê²½ë¡œ ì•ˆì „';
        obstacleStatus.className = 'alert-message alert-normal';
        updateSafetyStatus();
        speakMessage('ì¥ì• ë¬¼ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ê²½ë¡œê°€ ì•ˆì „í•©ë‹ˆë‹¤.');
    }, 3000);
}`;

        // HTML ì „ì²´ ì½”ë“œ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
        function getFullHtmlCode() {
            return document.documentElement.outerHTML;
        }

        // ëª¨ë‹ˆí„°ë§ ì½”ë“œ í† ê¸€ ê¸°ëŠ¥
        function toggleMonitoringCodeDisplay() {
            const monitoringCodeToggle = document.getElementById('monitoringCodeToggle');
            const monitoringCodeDiv = document.getElementById('monitoringCode');
            const monitoringCodeContent = document.getElementById('monitoringCodeContent');

            if (monitoringCodeToggle.checked) {
                monitoringCodeContent.textContent = monitoringCode;
                monitoringCodeDiv.classList.add('show');
            } else {
                monitoringCodeDiv.classList.remove('show');
            }
        }

        // ëª¨ë‹ˆí„°ë§ ì½”ë“œ ë³µì‚¬ ê¸°ëŠ¥
        function copyMonitoringCode() {
            const monitoringCopyBtn = document.getElementById('monitoringCopyBtn');
            
            navigator.clipboard.writeText(monitoringCode).then(() =&gt; {
                monitoringCopyBtn.textContent = 'âœ… ë³µì‚¬ë¨!';
                monitoringCopyBtn.classList.add('copied');
                
                setTimeout(() =&gt; {
                    monitoringCopyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                    monitoringCopyBtn.classList.remove('copied');
                }, 2000);
            }).catch(err =&gt; {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                monitoringCopyBtn.textContent = 'âŒ ì‹¤íŒ¨';
                setTimeout(() =&gt; {
                    monitoringCopyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                }, 2000);
            });
        }

        // HTML ì½”ë“œ í† ê¸€ ê¸°ëŠ¥
        function toggleHtmlCodeDisplay() {
            const htmlCodeToggle = document.getElementById('htmlCodeToggle');
            const htmlCodeDiv = document.getElementById('htmlCode');
            const htmlCodeContent = document.getElementById('htmlCodeContent');

            if (htmlCodeToggle.checked) {
                const fullHtmlCode = getFullHtmlCode();
                htmlCodeContent.textContent = fullHtmlCode;
                htmlCodeDiv.classList.add('show');
            } else {
                htmlCodeDiv.classList.remove('show');
            }
        }

        // HTML ì½”ë“œ ë³µì‚¬ ê¸°ëŠ¥
        function copyHtmlCode() {
            const htmlCopyBtn = document.getElementById('htmlCopyBtn');
            const fullHtmlCode = getFullHtmlCode();
            
            navigator.clipboard.writeText(fullHtmlCode).then(() =&gt; {
                htmlCopyBtn.textContent = 'âœ… ë³µì‚¬ë¨!';
                htmlCopyBtn.classList.add('copied');
                
                setTimeout(() =&gt; {
                    htmlCopyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                    htmlCopyBtn.classList.remove('copied');
                }, 2000);
            }).catch(err =&gt; {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                htmlCopyBtn.textContent = 'âŒ ì‹¤íŒ¨';
                setTimeout(() =&gt; {
                    htmlCopyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                }, 2000);
            });
        }

        // ìŒì„± í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        function testSpeech() {
            console.log('ğŸ¤ ìŒì„± í…ŒìŠ¤íŠ¸ ì‹œì‘');
            speakMessage('ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ìŒì„± í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤. ìŒì„±ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ê³  ìˆìŠµë‹ˆë‹¤.', 'high');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            // ì•± ì´ˆê¸°í™” (DOM ìš”ì†Œ ë° MQTT ì—°ê²°)
            initializeApp();
            
            // ìŒì„± ì‹œìŠ¤í…œ ì´ˆê¸°í™”
            initializeSpeech();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            document.getElementById('codeToggle').addEventListener('change', toggleCodeDisplay);
            document.getElementById('copyBtn').addEventListener('click', copyCode);
            document.getElementById('nanoCodeToggle').addEventListener('change', toggleNanoCodeDisplay);
            document.getElementById('nanoCopyBtn').addEventListener('click', copyNanoCode);
            document.getElementById('monitoringCodeToggle').addEventListener('change', toggleMonitoringCodeDisplay);
            document.getElementById('monitoringCopyBtn').addEventListener('click', copyMonitoringCode);
            document.getElementById('htmlCodeToggle').addEventListener('change', toggleHtmlCodeDisplay);
            document.getElementById('htmlCopyBtn').addEventListener('click', copyHtmlCode);
        });
    &lt;/script&gt;

&lt;/body&gt;&lt;/html&gt;</div>
        </div>

        <div class="connection-status connected" id="connectionStatus">âœ… MQTT ì„œë²„ ì—°ê²°ë¨</div>

        <div style="text-align: center; margin: 20px;">
            <button onclick="testSpeech()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 16px;">
                ğŸ”Š ìŒì„± í…ŒìŠ¤íŠ¸
            </button>
            <small style="display: block; margin-top: 5px; color: #666;">
                ìŒì„±ì´ ì•ˆ ë“¤ë¦¬ë©´ ì´ ë²„íŠ¼ì„ ë¨¼ì € í´ë¦­í•˜ì„¸ìš”
            </small>
        </div>

        <div class="status-panel">
            <div class="card">
                <div class="card-title">ğŸ“ ê±°ë¦¬ ì„¼ì„œ ë°ì´í„°</div>
                <div class="sensor-data">
                    <span class="sensor-label">ì„¼ì„œ 1:</span>
                    <span class="sensor-value" id="distance1">-- cm</span>
                    <span class="status-indicator status-normal" id="status1"></span>
                </div>
                <div class="sensor-data">
                    <span class="sensor-label">ì„¼ì„œ 2:</span>
                    <span class="sensor-value" id="distance2">-- cm</span>
                    <span class="status-indicator status-normal" id="status2"></span>
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸš¨ ì•ˆì „ ìƒíƒœ</div>
                <div class="alert-message alert-normal" id="safetyStatus">
                    ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™ ì¤‘
                </div>
            </div>

            <div class="card">
                <div class="card-title">âš ï¸ ë‚™ìƒ ê°ì§€</div>
                <div class="alert-message alert-normal" id="fallStatus">
                    ì •ìƒ ìƒíƒœ
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸš§ ì¥ì• ë¬¼ ê°ì§€</div>
                <div class="alert-message alert-normal" id="obstacleStatus">
                    ê²½ë¡œ ì•ˆì „
                </div>
            </div>
        </div>

        <div class="timestamp" id="lastUpdate">
            ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: --
        </div>
    </div>

    <script>
        const MQTT_TOPIC_SUB = 'SC_pub'; // ì•„ë‘ì´ë…¸ì—ì„œ publishí•˜ëŠ” í† í”½ì„ êµ¬ë…

        let client;
        let isConnected = false;

        // DOM ìš”ì†Œë“¤
        let connectionStatus, distance1, distance2, status1, status2;
        let safetyStatus, fallStatus, obstacleStatus, lastUpdate;

        // ìŒì„± ì•Œë¦¼ ì œì–´ ë³€ìˆ˜
        let lastSpeechTime = 0;
        let lastSensorSpeech = 0;
        const speechCooldown = 10000; // 10ì´ˆ ê°„ê²©ìœ¼ë¡œ ìŒì„± ì•Œë¦¼ ì œí•œ

        // í˜ì´ì§€ ë¡œë“œ í›„ DOM ìš”ì†Œ ì´ˆê¸°í™” ë° MQTT ì—°ê²°
        function initializeApp() {
            // DOM ìš”ì†Œë“¤ ì´ˆê¸°í™”
            connectionStatus = document.getElementById('connectionStatus');
            distance1 = document.getElementById('distance1');
            distance2 = document.getElementById('distance2');
            status1 = document.getElementById('status1');
            status2 = document.getElementById('status2');
            safetyStatus = document.getElementById('safetyStatus');
            fallStatus = document.getElementById('fallStatus');
            obstacleStatus = document.getElementById('obstacleStatus');
            lastUpdate = document.getElementById('lastUpdate');

            // MQTT ì—°ê²° (HTTPS/HTTP ìë™ ê°ì§€)
            const clientId = 'webClient_' + Math.random().toString(16).substr(2, 8);
            const isHttps = location.protocol === 'https:';
            const mqttUrl = isHttps ? 'wss://pubcode2.iptime.org:39002' : 'ws://pubcode2.iptime.org:39001';
            
            console.log('ğŸ”Œ MQTT ì—°ê²° ì‹œë„:', clientId);
            console.log('í˜„ì¬ í”„ë¡œí† ì½œ:', location.protocol);
            console.log('ì„œë²„ ì£¼ì†Œ:', mqttUrl);
            
            try {
                client = mqtt.connect(mqttUrl, {
                    clientId: clientId,
                    clean: true,
                    keepalive: 30,
                    connectTimeout: 15 * 1000,
                    reconnectPeriod: 5000,
                    protocolVersion: 4,
                    username: undefined,
                    password: undefined
                });
                
                console.log('ğŸ“¡ MQTT í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ MQTT í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
                if (isHttps) {
                    console.warn('âš ï¸ HTTPSì—ì„œ WSS ì—°ê²° ì‹¤íŒ¨ - HTTPë¡œ ì ‘ì†í•´ë³´ì„¸ìš”');
                    console.log('ğŸ”— HTTP ì£¼ì†Œ: http://poly.pubcode.kr/B03/index.html');
                    updateConnectionStatus(false, 'âŒ WSS ì—°ê²° ì‹¤íŒ¨ - HTTPë¡œ ì ‘ì†í•˜ì„¸ìš”');
                } else {
                    updateConnectionStatus(false, 'í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì‹¤íŒ¨');
                }
                return;
            }

            setupMQTTEvents();
        }

        // MQTT ì´ë²¤íŠ¸ ì„¤ì •
        function setupMQTTEvents() {
            console.log('ğŸ”§ MQTT ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì • ì¤‘...');
            console.log('ë¸Œë¼ìš°ì €:', navigator.userAgent);
            
            client.on('connect', () => {
                console.log('âœ… WebSocket MQTT ì—°ê²° ì„±ê³µ!');
                isConnected = true;
                updateConnectionStatus(true);
                client.subscribe(MQTT_TOPIC_SUB, (err) => {
                    if (err) {
                        console.error('âŒ í† í”½ êµ¬ë… ì‹¤íŒ¨:', err);
                    } else {
                        console.log('ğŸ“¡ í† í”½ êµ¬ë… ì„±ê³µ:', MQTT_TOPIC_SUB);
                        // ìŒì„± ì•Œë¦¼
                        speakMessage('ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ì‹œìŠ¤í…œì´ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤. ëª¨ë‹ˆí„°ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤.');
                    }
                });
            });

            client.on('message', (topic, message) => {
                const data = message.toString();
                console.log('ğŸ“© ìˆ˜ì‹ ëœ ë©”ì‹œì§€:', data);
                processMessage(data);
                updateTimestamp();
            });

            client.on('error', (error) => {
                console.error('âŒ MQTT ì—°ê²° ì˜¤ë¥˜:', error);
                console.error('ì˜¤ë¥˜ ìƒì„¸:', error.message);
                isConnected = false;
                updateConnectionStatus(false);
            });

            client.on('offline', () => {
                console.log('ğŸ“´ MQTT ì˜¤í”„ë¼ì¸ ìƒíƒœ');
                isConnected = false;
                updateConnectionStatus(false);
            });

            client.on('close', () => {
                console.log('ğŸ”Œ MQTT ì—°ê²° ì¢…ë£Œ');
                isConnected = false;
                updateConnectionStatus(false);
            });

            client.on('reconnect', () => {
                console.log('ğŸ”„ MQTT ì¬ì—°ê²° ì‹œë„ ì¤‘...');
            });

            client.on('disconnect', () => {
                console.log('âš ï¸ MQTT ì—°ê²° í•´ì œ');
                isConnected = false;
                updateConnectionStatus(false);
            });

            // ì—°ê²° ì‹œë„ íƒ€ì„ì•„ì›ƒ ì„¤ì • (5ì´ˆ)
            setTimeout(() => {
                if (!isConnected) {
                    console.warn('â° MQTT ì—°ê²° íƒ€ì„ì•„ì›ƒ (5ì´ˆ)');
                    if (location.protocol === 'https:') {
                        console.log('ğŸš¨ HTTPSì—ì„œ WSS ì—°ê²° ì‹¤íŒ¨!');
                        console.log('ğŸ’¡ í•´ê²° ë°©ë²•: HTTPë¡œ ì ‘ì†í•˜ì„¸ìš”');
                        console.log('ğŸ”— HTTP ì£¼ì†Œ: http://poly.pubcode.kr/B03/index.html');
                        updateConnectionStatus(false, 'âŒ WSS ì„œë²„ ì—†ìŒ - HTTPë¡œ ì ‘ì† í•„ìš”');
                        
                        // HTTP ë§í¬ë¥¼ í™”ë©´ì— í‘œì‹œ
                        showHttpLink();
                    } else {
                        console.log('ğŸ”§ ì—°ê²° ë¬¸ì œ í•´ê²° ë°©ë²•:');
                        console.log('1. ë„¤íŠ¸ì›Œí¬ ì—°ê²° í™•ì¸');
                        console.log('2. ë°©í™”ë²½ ì„¤ì • í™•ì¸');
                        console.log('3. MQTT ì„œë²„ ìƒíƒœ í™•ì¸');
                        updateConnectionStatus(false, 'ì—°ê²° íƒ€ì„ì•„ì›ƒ - ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”');
                    }
                }
            }, 5000);
        }

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(connected, customMessage = null) {
            if (connected) {
                connectionStatus.textContent = 'âœ… MQTT ì„œë²„ ì—°ê²°ë¨';
                connectionStatus.className = 'connection-status connected';
            } else {
                const message = customMessage || 'âŒ MQTT ì„œë²„ ì—°ê²° ì‹¤íŒ¨';
                connectionStatus.textContent = message;
                connectionStatus.className = 'connection-status disconnected';
            }
        }

        // ë©”ì‹œì§€ ì²˜ë¦¬
        function processMessage(data) {
            console.log('ì²˜ë¦¬ ì¤‘ì¸ ë©”ì‹œì§€:', data);
            
            // JSON í˜•íƒœ ë‚™ìƒ ì‹ í˜¸ ì²´í¬
            if (data.includes('"event":"FALL"') || data.includes("'event':'FALL'")) {
                handleFallDetection();
                return;
            }
            
            // ê¸°ì¡´ ë¬¸ìì—´ í˜•íƒœ ë‚™ìƒ ì‹ í˜¸ ì²´í¬
            if (data === 'FALL') {
                handleFallDetection();
                return;
            }
            
            // JSON í˜•íƒœ ë°ì´í„° íŒŒì‹± ì‹œë„
            try {
                const jsonData = JSON.parse(data);
                if (jsonData.event === 'FALL') {
                    handleFallDetection();
                    return;
                }
                if (jsonData.sensor1 !== undefined && jsonData.sensor2 !== undefined) {
                    updateSensorDisplay(1, jsonData.sensor1);
                    updateSensorDisplay(2, jsonData.sensor2);
                    return;
                }
            } catch (e) {
                // JSONì´ ì•„ë‹Œ ê²½ìš° ê³„ì† ì§„í–‰
            }
            
            if (data.includes('Distance Alert!')) {
                handleDistanceAlert(data);
                parseDistanceData(data); // Distance Alertì—ì„œë„ ê±°ë¦¬ ë°ì´í„° íŒŒì‹±
            } else if (data.includes('d1=') && data.includes('d2=')) {
                parseDistanceData(data);
            } else if (data.includes('ì„¼ì„œ1') && data.includes('ì„¼ì„œ2')) {
                // "ì„¼ì„œ1 ê±°ë¦¬: 25 cm | ì„¼ì„œ2 ê±°ë¦¬: 30 cm" í˜•íƒœ íŒŒì‹±
                parseKoreanDistanceData(data);
            } else if (data.includes('ê±°ë¦¬:')) {
                // ê°œë³„ ì„¼ì„œ ë°ì´í„° íŒŒì‹±
                parseIndividualSensorData(data);
            } else {
                // ê¸°íƒ€ ìˆ«ì ë°ì´í„°ë‚˜ JSON í˜•íƒœ ì‹œë„
                tryParseNumericData(data);
            }
        }

        // ìŒì„± ì•Œë¦¼ í•¨ìˆ˜ (í¬ë¡¬ HTTP í˜¸í™˜ì„± ê°œì„ )
        function speakMessage(message, priority = 'normal') {
            const currentTime = Date.now();
            
            // ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ ê²½ìš° (ë‚™ìƒ, ì¥ì• ë¬¼) ì¦‰ì‹œ ì¬ìƒ
            if (priority === 'high' || currentTime - lastSpeechTime > speechCooldown) {
                if ('speechSynthesis' in window) {
                    try {
                        // ê¸°ì¡´ ìŒì„± ì •ì§€
                        window.speechSynthesis.cancel();
                        
                        // í¬ë¡¬ì—ì„œ ìŒì„± ëª©ë¡ ë¡œë“œ ëŒ€ê¸°
                        const voices = window.speechSynthesis.getVoices();
                        
                        const utterance = new SpeechSynthesisUtterance(message);
                        
                        // í•œêµ­ì–´ ìŒì„± ì°¾ê¸°
                        const koreanVoice = voices.find(voice => 
                            voice.lang.includes('ko') || voice.lang.includes('KR')
                        );
                        
                        if (koreanVoice) {
                            utterance.voice = koreanVoice;
                            utterance.lang = koreanVoice.lang;
                        } else {
                            utterance.lang = 'ko-KR';
                        }
                        
                        utterance.rate = 0.9;
                        utterance.pitch = 1.0;
                        utterance.volume = 1.0;
                        
                        // í¬ë¡¬ HTTPì—ì„œ ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ì—†ì´ ì¬ìƒ ì‹œë„
                        const playPromise = new Promise((resolve) => {
                            utterance.onstart = () => {
                                console.log('ğŸ”Š ìŒì„± ì¬ìƒ ì‹œì‘:', message);
                                resolve();
                            };
                            utterance.onerror = (event) => {
                                console.warn('ğŸ”‡ ìŒì„± ì¬ìƒ ì‹¤íŒ¨:', event.error);
                                console.log('ğŸ’¡ í•´ê²° ë°©ë²•: í˜ì´ì§€ë¥¼ í´ë¦­í•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
                                resolve();
                            };
                            utterance.onend = () => {
                                console.log('ğŸ”Š ìŒì„± ì¬ìƒ ì™„ë£Œ');
                            };
                        });
                        
                        window.speechSynthesis.speak(utterance);
                        console.log('ğŸ”Š ìŒì„± ì•Œë¦¼ ìš”ì²­:', message);
                        
                        lastSpeechTime = currentTime;
                        
                    } catch (error) {
                        console.error('ğŸ”‡ ìŒì„± í•©ì„± ì˜¤ë¥˜:', error);
                        showTextAlert(message); // ëŒ€ì²´ í…ìŠ¤íŠ¸ ì•Œë¦¼
                    }
                } else {
                    console.warn('ğŸ”‡ ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    showTextAlert(message); // ëŒ€ì²´ í…ìŠ¤íŠ¸ ì•Œë¦¼
                }
            } else {
                console.log('ğŸ”‡ ìŒì„± ì•Œë¦¼ ìŠ¤í‚µ (ì¿¨ë‹¤ìš´):', message);
            }
        }

        // ìŒì„±ì´ ì•ˆ ë  ë•Œ ëŒ€ì²´ í…ìŠ¤íŠ¸ ì•Œë¦¼
        function showTextAlert(message) {
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #ff4444;
                color: white;
                padding: 20px;
                border-radius: 10px;
                font-size: 18px;
                font-weight: bold;
                z-index: 2000;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                max-width: 80%;
                text-align: center;
            `;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            // 3ì´ˆ í›„ ì œê±°
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // ìŒì„± ê¶Œí•œ ìš”ì²­ ë° ì´ˆê¸°í™”
        function initializeSpeech() {
            if ('speechSynthesis' in window) {
                // í¬ë¡¬ì—ì„œ ìŒì„± ëª©ë¡ ë¡œë“œ ëŒ€ê¸°
                const loadVoices = () => {
                    const voices = window.speechSynthesis.getVoices();
                    console.log('ğŸ¤ ì‚¬ìš© ê°€ëŠ¥í•œ ìŒì„±:', voices.length, 'ê°œ');
                    
                    const koreanVoices = voices.filter(voice => 
                        voice.lang.includes('ko') || voice.lang.includes('KR')
                    );
                    console.log('ğŸ‡°ğŸ‡· í•œêµ­ì–´ ìŒì„±:', koreanVoices.length, 'ê°œ');
                    
                    if (koreanVoices.length > 0) {
                        console.log('âœ… í•œêµ­ì–´ ìŒì„± ì‚¬ìš© ê°€ëŠ¥');
                    } else {
                        console.warn('âš ï¸ í•œêµ­ì–´ ìŒì„±ì´ ì—†ì–´ ê¸°ë³¸ ìŒì„±ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                    }
                };

                // ìŒì„± ëª©ë¡ì´ ë¡œë“œë˜ë©´ ì‹¤í–‰
                if (window.speechSynthesis.getVoices().length > 0) {
                    loadVoices();
                } else {
                    window.speechSynthesis.onvoiceschanged = loadVoices;
                }
                
                // ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ìœ¼ë¡œ ìŒì„± ê¶Œí•œ í™œì„±í™”
                document.addEventListener('click', function enableSpeech() {
                    const testUtterance = new SpeechSynthesisUtterance('');
                    window.speechSynthesis.speak(testUtterance);
                    window.speechSynthesis.cancel();
                    console.log('ğŸ”Š ìŒì„± ê¶Œí•œ í™œì„±í™”ë¨');
                    document.removeEventListener('click', enableSpeech);
                }, { once: true });
            }
        }

        // ë‚™ìƒ ê°ì§€ ì²˜ë¦¬
        function handleFallDetection() {
            fallStatus.textContent = 'ğŸš¨ ë‚™ìƒ ê°ì§€ë¨!';
            fallStatus.className = 'alert-message alert-fall';
            safetyStatus.textContent = 'ğŸš¨ ì‘ê¸‰ ìƒí™© ë°œìƒ!';
            safetyStatus.className = 'alert-message alert-fall';

            // ìŒì„± ì•Œë¦¼ (ë†’ì€ ìš°ì„ ìˆœìœ„)
            speakMessage('ê²½ê³ ! ë‚™ìƒì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì‘ê¸‰ ìƒí™©ì…ë‹ˆë‹¤.', 'high');

            // 5ì´ˆ í›„ ì •ìƒ ìƒíƒœë¡œ ë³µê·€
            setTimeout(() => {
                fallStatus.textContent = 'ì •ìƒ ìƒíƒœ';
                fallStatus.className = 'alert-message alert-normal';
                updateSafetyStatus();
                speakMessage('ë‚™ìƒ ê²½ê³ ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }, 5000);
        }

        // ê±°ë¦¬ ê²½ê³  ì²˜ë¦¬
        function handleDistanceAlert(data) {
            obstacleStatus.textContent = 'âš ï¸ ì¥ì• ë¬¼ ê°ì§€! (20cm ë¯¸ë§Œ)';
            obstacleStatus.className = 'alert-message alert-obstacle';
            safetyStatus.textContent = 'âš ï¸ ì£¼ì˜ í•„ìš”';
            safetyStatus.className = 'alert-message alert-obstacle';

            // ìŒì„± ì•Œë¦¼ (ë†’ì€ ìš°ì„ ìˆœìœ„)
            speakMessage('ì£¼ì˜! ì¥ì• ë¬¼ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'high');

            // 3ì´ˆ í›„ ì •ìƒ ìƒíƒœë¡œ ë³µê·€
            setTimeout(() => {
                obstacleStatus.textContent = 'ê²½ë¡œ ì•ˆì „';
                obstacleStatus.className = 'alert-message alert-normal';
                updateSafetyStatus();
                speakMessage('ì¥ì• ë¬¼ ê²½ê³ ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ê²½ë¡œê°€ ì•ˆì „í•©ë‹ˆë‹¤.');
            }, 3000);
        }

        // ê±°ë¦¬ ë°ì´í„° íŒŒì‹± (d1=25, d2=30 í˜•íƒœ)
        function parseDistanceData(data) {
            const d1Match = data.match(/d1=(\d+)/);
            const d2Match = data.match(/d2=(\d+)/);

            if (d1Match) {
                const dist1 = parseInt(d1Match[1]);
                updateSensorDisplay(1, dist1);
            }

            if (d2Match) {
                const dist2 = parseInt(d2Match[1]);
                updateSensorDisplay(2, dist2);
            }
        }

        // í•œêµ­ì–´ ê±°ë¦¬ ë°ì´í„° íŒŒì‹± ("ì„¼ì„œ1 ê±°ë¦¬: 25 cm | ì„¼ì„œ2 ê±°ë¦¬: 30 cm" í˜•íƒœ)
        function parseKoreanDistanceData(data) {
            const sensor1Match = data.match(/ì„¼ì„œ1\s*ê±°ë¦¬:\s*(\d+)\s*cm/);
            const sensor2Match = data.match(/ì„¼ì„œ2\s*ê±°ë¦¬:\s*(\d+)\s*cm/);

            if (sensor1Match) {
                const dist1 = parseInt(sensor1Match[1]);
                updateSensorDisplay(1, dist1);
            }

            if (sensor2Match) {
                const dist2 = parseInt(sensor2Match[1]);
                updateSensorDisplay(2, dist2);
            }
        }

        // ê°œë³„ ì„¼ì„œ ë°ì´í„° íŒŒì‹±
        function parseIndividualSensorData(data) {
            // "ê±°ë¦¬: 25" ë˜ëŠ” "Distance: 25" í˜•íƒœ
            const distMatch = data.match(/ê±°ë¦¬:\s*(\d+)/);
            if (distMatch) {
                const distance = parseInt(distMatch[1]);
                // ë§ˆì§€ë§‰ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•  ì„¼ì„œ ê²°ì • (êµëŒ€ë¡œ ì—…ë°ì´íŠ¸)
                const currentTime = Date.now();
                const sensorNum = Math.floor(currentTime / 1000) % 2 + 1;
                updateSensorDisplay(sensorNum, distance);
            }
        }

        // ìˆ«ì ë°ì´í„° ì‹œë„ íŒŒì‹±
        function tryParseNumericData(data) {
            // JSON í˜•íƒœ ì‹œë„
            try {
                const jsonData = JSON.parse(data);
                if (jsonData.sensor1 !== undefined) {
                    updateSensorDisplay(1, jsonData.sensor1);
                }
                if (jsonData.sensor2 !== undefined) {
                    updateSensorDisplay(2, jsonData.sensor2);
                }
                return;
            } catch (e) {
                // JSONì´ ì•„ë‹˜
            }

            // ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ë‘ ìˆ«ì ì‹œë„ "25,30"
            const csvMatch = data.match(/^(\d+),(\d+)$/);
            if (csvMatch) {
                updateSensorDisplay(1, parseInt(csvMatch[1]));
                updateSensorDisplay(2, parseInt(csvMatch[2]));
                return;
            }

            // ë‹¨ìˆœ ìˆ«ì í•˜ë‚˜ë§Œ ìˆëŠ” ê²½ìš°
            const numMatch = data.match(/^\d+$/);
            if (numMatch) {
                const distance = parseInt(data);
                // êµëŒ€ë¡œ ì„¼ì„œì— í• ë‹¹
                const sensorNum = Math.floor(Date.now() / 1000) % 2 + 1;
                updateSensorDisplay(sensorNum, distance);
            }
        }

        // ì„¼ì„œ í‘œì‹œ ì—…ë°ì´íŠ¸ (í†µí•© í•¨ìˆ˜)
        function updateSensorDisplay(sensorNum, distance) {
            console.log(`ì„¼ì„œ${sensorNum} ì—…ë°ì´íŠ¸: ${distance}cm`);
            
            if (sensorNum === 1) {
                distance1.textContent = distance + ' cm';
                updateSensorStatus(status1, distance);
            } else if (sensorNum === 2) {
                distance2.textContent = distance + ' cm';
                updateSensorStatus(status2, distance);
            }

            // ì¥ì• ë¬¼ ê°ì§€ ì²´í¬
            if (distance < 20) {
                triggerObstacleAlert(sensorNum, distance);
            } else {
                // ì •ìƒ ìƒíƒœì¼ ë•Œ 30ì´ˆë§ˆë‹¤ ìƒíƒœ ì•Œë¦¼
                const currentTime = Date.now();
                if (currentTime - lastSensorSpeech > 30000) {
                    speakMessage(`ì„¼ì„œê°€ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤. ì „ë°© ê²½ë¡œê°€ ì•ˆì „í•©ë‹ˆë‹¤.`);
                    lastSensorSpeech = currentTime;
                }
            }
        }

        // ì¥ì• ë¬¼ ê²½ê³  íŠ¸ë¦¬ê±°
        function triggerObstacleAlert(sensorNum, distance) {
            console.log(`ì¥ì• ë¬¼ ê°ì§€! ì„¼ì„œ${sensorNum}: ${distance}cm`);
            obstacleStatus.textContent = `âš ï¸ ì„¼ì„œ${sensorNum}ì—ì„œ ì¥ì• ë¬¼ ê°ì§€! (${distance}cm)`;
            obstacleStatus.className = 'alert-message alert-obstacle';
            safetyStatus.textContent = 'âš ï¸ ì£¼ì˜ í•„ìš”';
            safetyStatus.className = 'alert-message alert-obstacle';

            // ìŒì„± ì•Œë¦¼ (ì„¼ì„œë³„ êµ¬ë¶„, ë†’ì€ ìš°ì„ ìˆœìœ„)
            speakMessage(`ì£¼ì˜! ì„¼ì„œ ${sensorNum}ì—ì„œ ${distance}ì„¼í‹°ë¯¸í„° ê±°ë¦¬ì— ì¥ì• ë¬¼ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'high');

            // 3ì´ˆ í›„ ì •ìƒ ìƒíƒœë¡œ ë³µê·€
            setTimeout(() => {
                if (!obstacleStatus.className.includes('alert-obstacle')) return;
                obstacleStatus.textContent = 'ê²½ë¡œ ì•ˆì „';
                obstacleStatus.className = 'alert-message alert-normal';
                updateSafetyStatus();
                speakMessage('ì¥ì• ë¬¼ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ê²½ë¡œê°€ ì•ˆì „í•©ë‹ˆë‹¤.');
            }, 3000);
        }

        // ì„¼ì„œ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSensorStatus(statusElement, distance) {
            if (distance < 20) {
                statusElement.className = 'status-indicator status-danger';
            } else if (distance < 50) {
                statusElement.className = 'status-indicator status-warning';
            } else {
                statusElement.className = 'status-indicator status-normal';
            }
        }

        // ì „ì²´ ì•ˆì „ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSafetyStatus() {
            if (fallStatus.className.includes('alert-fall') || 
                obstacleStatus.className.includes('alert-obstacle')) {
                return; // ì´ë¯¸ ê²½ê³  ìƒíƒœë©´ ë³€ê²½í•˜ì§€ ì•ŠìŒ
            }

            safetyStatus.textContent = 'âœ… ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™ ì¤‘';
            safetyStatus.className = 'alert-message alert-normal';
        }

        // íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸
        function updateTimestamp() {
            const now = new Date();
            lastUpdate.textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${now.toLocaleString('ko-KR')}`;
        }

        // HTTP ë§í¬ í‘œì‹œ
        function showHttpLink() {
            const linkDiv = document.createElement('div');
            linkDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #dc3545;
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 1000;
                text-align: center;
                font-weight: bold;
            `;
            linkDiv.innerHTML = `
                ğŸš¨ HTTPSì—ì„œ MQTT ì—°ê²° ë¶ˆê°€<br>
                <a href="http://poly.pubcode.kr/B03/index.html" 
                   style="color: #fff3cd; text-decoration: underline;">
                   HTTP ë²„ì „ìœ¼ë¡œ ì´ë™í•˜ê¸°
                </a>
                <button onclick="this.parentElement.remove()" 
                        style="margin-left: 10px; background: none; border: 1px solid white; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                   ë‹«ê¸°
                </button>
            `;
            document.body.appendChild(linkDiv);
            
            // 10ì´ˆ í›„ ìë™ìœ¼ë¡œ ì œê±°
            setTimeout(() => {
                if (linkDiv.parentElement) {
                    linkDiv.remove();
                }
            }, 10000);
        }

        // Arduino UNO R4 WIFI ì½”ë“œ (ìµœì‹  ì—…ë°ì´íŠ¸)
        const arduinoCode = `#include <Arduino.h>
#include <WiFiS3.h>         // UNO R4 WiFi ìš©
#include <PubSubClient.h>   // MQTT ë¼ì´ë¸ŒëŸ¬ë¦¬

#define RX_BAUD 9600

// WiFi ì •ë³´
const char* ssid = "SmartCenter 2.4G";
const char* password = "12345678";

// MQTT ì„œë²„ ì •ë³´
const char* mqtt_server = "pubcode2.iptime.org";
const int mqtt_port = 31883;
const char* mqtt_topic_sub = "SC_sub";
const char* mqtt_topic_pub = "SC_pub";

WiFiClient espClient;
PubSubClient client(espClient);

// HC-SR04 ì„¼ì„œ1, ì„¼ì„œ2 í•€
#define TRIG1 5
#define ECHO1 4
#define TRIG2 2
#define ECHO2 3

// ì§„ë™ ëª¨í„°
#define VIBRATION_MOTOR 8
bool vibrationOn = false;

// ë²„ì €
#define BUZZER_PIN 9

// ê±°ë¦¬ì„¼ì„œ ê°’ ì£¼ê¸°ì  ì „ì†¡ìš©
unsigned long lastSendTime = 0;
const unsigned long sendInterval = 1000; // 1ì´ˆë§ˆë‹¤ ì „ì†¡

// ìŒê³„ ì •ì˜ (ìŠˆí¼ë§ˆë¦¬ì˜¤ í…Œë§ˆìš©)
#define NOTE_E4 330
#define NOTE_F4 349
#define NOTE_G4 392
#define NOTE_A4 440
#define NOTE_AS4 466
#define NOTE_B4 494
#define NOTE_C5 523
#define NOTE_D5 587
#define NOTE_E5 659
#define NOTE_F5 698
#define NOTE_G5 784
#define NOTE_A5 880

// ìŠˆí¼ë§ˆë¦¬ì˜¤ í…Œë§ˆ (ì§§ì€ ë²„ì „)
int marioMelody[] = {
  NOTE_E5, NOTE_E5, 0, NOTE_E5,
  0, NOTE_C5, NOTE_E5, 0,
  NOTE_G5, 0, 0,  0,
  NOTE_G4, 0, 0, 0,

  NOTE_C5, 0, 0, NOTE_G4,
  0, 0, NOTE_E4, 0,
  0, NOTE_A4, 0, NOTE_B4,
  0, NOTE_AS4, NOTE_A4, 0,

  NOTE_G4, NOTE_E5, NOTE_G5,
  NOTE_A5, 0, NOTE_F5, NOTE_G5,
  0, NOTE_E5, 0, NOTE_C5,
  NOTE_D5, NOTE_B4, 0, 0
};

int marioDurations[] = {
  150, 150, 150, 150,
  150, 150, 150, 150,
  150, 150, 150, 150,
  150, 150, 150, 150,

  150, 150, 150, 150,
  150, 150, 150, 150,
  150, 150, 150, 150,
  150, 150, 150, 150,

  150, 150, 150,
  150, 150, 150, 150,
  150, 150, 150, 150,
  150, 150, 150, 150
};

int marioLength = sizeof(marioMelody) / sizeof(int);

// ì´ˆìŒíŒŒ ê±°ë¦¬ ì¸¡ì • í•¨ìˆ˜
long getDistance(int trigPin, int echoPin) {
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);

  long duration = pulseIn(echoPin, HIGH, 20000); // íƒ€ì„ì•„ì›ƒ 20ms
  if (duration == 0) return 999; // ì¸¡ì • ì‹¤íŒ¨ì‹œ í° ê°’ ë°˜í™˜
  long distance = duration * 0.034 / 2;  // cm
  return distance;
}

// ìŠˆí¼ë§ˆë¦¬ì˜¤ ë©œë¡œë”” ì—°ì£¼
void playMario() {
  for (int i = 0; i < marioLength; i++) {
    int noteDuration = marioDurations[i];
    if (marioMelody[i] == 0) {
      noTone(BUZZER_PIN);
    } else {
      tone(BUZZER_PIN, marioMelody[i], noteDuration);
    }
    delay(noteDuration * 1.3);
  }
  noTone(BUZZER_PIN);
}

// MQTT ì¬ì—°ê²°
void reconnect() {
  while (!client.connected()) {
    Serial.print("MQTT ì—°ê²° ì‹œë„...");
    if (client.connect("ArduinoWiFiClient")) {
      Serial.println("ì—°ê²°ë¨");
      client.subscribe(mqtt_topic_sub);
    } else {
      Serial.print("ì‹¤íŒ¨, rc=");
      Serial.print(client.state());
      Serial.println(" 5ì´ˆ í›„ ì¬ì‹œë„");
      delay(5000);
    }
  }
}

void setup() {
  Serial.begin(9600);

  // ì´ˆìŒíŒŒ í•€ ëª¨ë“œ ì„¤ì •
  pinMode(TRIG1, OUTPUT);
  pinMode(ECHO1, INPUT);
  pinMode(TRIG2, OUTPUT);
  pinMode(ECHO2, INPUT);

  // ì§„ë™ëª¨í„° + ë²„ì € í•€
  pinMode(VIBRATION_MOTOR, OUTPUT);
  pinMode(BUZZER_PIN, OUTPUT);
  digitalWrite(VIBRATION_MOTOR, LOW);

  Serial1.begin(RX_BAUD); // Nano 33 TX â†” WiFi RX ì—°ê²°
  delay(2000);

  // WiFi ì—°ê²°
  Serial.print("WiFi ì—°ê²° ì¤‘: ");
  Serial.println(ssid);
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.print(".");
  }
  Serial.println("\nWiFi ì—°ê²° ì„±ê³µ!");
  Serial.print("IP ì£¼ì†Œ: ");
  Serial.println(WiFi.localIP());

  // MQTT ì„¤ì •
  client.setServer(mqtt_server, mqtt_port);

  Serial.println("HC-SR04 / Vibration Motor / Buzzer (Super Mario) ì‹œì‘");
  Serial.println("WiFi ë³´ë“œ - ë‚™ìƒ ì‹ í˜¸ ìˆ˜ì‹  ëŒ€ê¸° ì¤‘...");
}

void loop() {
  if (!client.connected()) {
    reconnect();
  }
  client.loop();

  // ì´ˆìŒíŒŒ ì„¼ì„œ ê°’ ì½ê¸°
  long dist1 = getDistance(TRIG1, ECHO1);
  long dist2 = getDistance(TRIG2, ECHO2);

  Serial.print("ì„¼ì„œ1 ê±°ë¦¬: ");
  Serial.print(dist1);
  Serial.print(" cm | ì„¼ì„œ2 ê±°ë¦¬: ");
  Serial.print(dist2);
  Serial.println(" cm");

  // ì£¼ê¸°ì ìœ¼ë¡œ ê±°ë¦¬ê°’ MQTT ì „ì†¡
  unsigned long now = millis();
  if (now - lastSendTime > sendInterval) {
    lastSendTime = now;
    char msg[100];
    sprintf(msg, "{\\"sensor1\\":%ld, \\"sensor2\\":%ld}", dist1, dist2);
    client.publish(mqtt_topic_pub, msg);
    Serial.print("MQTT ì „ì†¡: ");
    Serial.println(msg);
  }

  // ë‚™ìƒ ì‹ í˜¸ ìˆ˜ì‹  ì²˜ë¦¬
  if (Serial1.available()) {
    String data = Serial1.readStringUntil('\\n');
    data.trim();
    Serial.println(data);
    if (data == "FALL") {
      Serial.println(">>> ë‚™ìƒ ì‹ í˜¸ ìˆ˜ì‹ ë¨!");
      client.publish(mqtt_topic_pub, "{\\"event\\":\\"FALL\\"}");
    }
  }

  // ===== ê±°ë¦¬ ì¡°ê±´ìœ¼ë¡œ ìë™ ì œì–´ =====
  if (dist1 < 20 || dist2 < 20) {
    if (!vibrationOn) {
      vibrationOn = true;
      Serial.println("ê±°ë¦¬ < 20cm â†’ ì§„ë™ëª¨í„° ON (1ì´ˆ) + ë§ˆë¦¬ì˜¤ í…Œë§ˆ");
      digitalWrite(VIBRATION_MOTOR, HIGH);
      delay(1000);
      digitalWrite(VIBRATION_MOTOR, LOW);

      // ì¦‰ì‹œ MQTT ê²½ê³  ì „ì†¡
      char alertMsg[100];
      sprintf(alertMsg, "{\\"alert\\":\\"distance<20\\", \\"sensor1\\":%ld, \\"sensor2\\":%ld}", dist1, dist2);
      client.publish(mqtt_topic_pub, alertMsg);
      
      playMario();
    }
  } else {
    if (vibrationOn) {
      vibrationOn = false;
      Serial.println("ê±°ë¦¬ >= 20cm â†’ ì§„ë™ëª¨í„° OFF + ë²„ì € OFF");
      digitalWrite(VIBRATION_MOTOR, LOW);
      noTone(BUZZER_PIN);
    }
  }

  delay(300);
}`;

        // ì½”ë“œ í† ê¸€ ê¸°ëŠ¥
        function toggleCodeDisplay() {
            const codeToggle = document.getElementById('codeToggle');
            const arduinoCodeDiv = document.getElementById('arduinoCode');
            const codeContent = document.getElementById('codeContent');

            if (codeToggle.checked) {
                codeContent.textContent = arduinoCode;
                arduinoCodeDiv.classList.add('show');
            } else {
                arduinoCodeDiv.classList.remove('show');
            }
        }

        // ì½”ë“œ ë³µì‚¬ ê¸°ëŠ¥
        function copyCode() {
            const copyBtn = document.getElementById('copyBtn');
            
            navigator.clipboard.writeText(arduinoCode).then(() => {
                copyBtn.textContent = 'âœ… ë³µì‚¬ë¨!';
                copyBtn.classList.add('copied');
                
                setTimeout(() => {
                    copyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                    copyBtn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                copyBtn.textContent = 'âŒ ì‹¤íŒ¨';
                setTimeout(() => {
                    copyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                }, 2000);
            });
        }

        // Arduino Nano 33 BLE ì½”ë“œ
        const nanoArduinoCode = `#include <Arduino_LSM9DS1.h>  // Nano 33 Sense Rev2 IMU ë¼ì´ë¸ŒëŸ¬ë¦¬

#define THRESHOLD 4   // g ë‹¨ìœ„, 2.5g ì´ìƒ ê¸‰ê²©í•œ ë³€í™”ë©´ ë‚™ìƒìœ¼ë¡œ íŒë‹¨
#define TX_BAUD 9600

void setup() {
  Serial.begin(9600);     // PC ëª¨ë‹ˆí„°ë§ìš©
  Serial1.begin(TX_BAUD); // ë‹¤ë¥¸ ì•„ë‘ì´ë…¸ë¡œ ì „ì†¡ (TX=Nano D1, RX=ìƒëŒ€ë³´ë“œ RXí•€)
  
  if (!IMU.begin()) {
    Serial.println("IMU ì´ˆê¸°í™” ì‹¤íŒ¨!");
    while (1);
  }
  Serial.println("IMU ì‹œì‘ - ë‚™ìƒ ê°ì§€ ëŒ€ê¸° ì¤‘...");
}

void loop() {
  float x, y, z;

  if (IMU.accelerationAvailable()) {
    IMU.readAcceleration(x, y, z);

    float magnitude = sqrt(x * x + y * y + z * z); // ê°€ì†ë„ í¬ê¸° (g ë‹¨ìœ„)

    if (magnitude > 3) {
       Serial.println(magnitude);
    }

    if (magnitude > THRESHOLD) {
      Serial.println("ë‚™ìƒ ê°ì§€!");
      Serial1.println("FALL");   // ë‹¤ë¥¸ ë³´ë“œë¡œ ë‚™ìƒ ì‹ í˜¸ ì „ì†¡
      delay(1000);               // ì¤‘ë³µ ê°ì§€ ë°©ì§€
    }
  } 
}`;

        // ì½”ë“œ í† ê¸€ ê¸°ëŠ¥ (Nano 33 BLE)
        function toggleNanoCodeDisplay() {
            const nanoCodeToggle = document.getElementById('nanoCodeToggle');
            const nanoArduinoCodeDiv = document.getElementById('nanoArduinoCode');
            const nanoCodeContent = document.getElementById('nanoCodeContent');

            if (nanoCodeToggle.checked) {
                nanoCodeContent.textContent = nanoArduinoCode;
                nanoArduinoCodeDiv.classList.add('show');
            } else {
                nanoArduinoCodeDiv.classList.remove('show');
            }
        }

        // ì½”ë“œ ë³µì‚¬ ê¸°ëŠ¥ (Nano 33 BLE)
        function copyNanoCode() {
            const nanoCopyBtn = document.getElementById('nanoCopyBtn');
            
            navigator.clipboard.writeText(nanoArduinoCode).then(() => {
                nanoCopyBtn.textContent = 'âœ… ë³µì‚¬ë¨!';
                nanoCopyBtn.classList.add('copied');
                
                setTimeout(() => {
                    nanoCopyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                    nanoCopyBtn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                nanoCopyBtn.textContent = 'âŒ ì‹¤íŒ¨';
                setTimeout(() => {
                    nanoCopyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                }, 2000);
            });
        }

        // ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ëª¨ë‹ˆí„°ë§ ì½”ë“œ (JavaScript ë¶€ë¶„)
        const monitoringCode = `// ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ - JavaScript Core Functions

// MQTT ì—°ê²° ë° ë©”ì‹œì§€ ì²˜ë¦¬
const MQTT_TOPIC_SUB = 'SC_pub';
let client;
let isConnected = false;

// ìŒì„± ì•Œë¦¼ ì œì–´ ë³€ìˆ˜
let lastSpeechTime = 0;
let lastSensorSpeech = 0;
const speechCooldown = 10000; // 10ì´ˆ ê°„ê²©

// ì•± ì´ˆê¸°í™” í•¨ìˆ˜
function initializeApp() {
    // DOM ìš”ì†Œë“¤ ì´ˆê¸°í™”
    connectionStatus = document.getElementById('connectionStatus');
    distance1 = document.getElementById('distance1');
    distance2 = document.getElementById('distance2');
    status1 = document.getElementById('status1');
    status2 = document.getElementById('status2');
    safetyStatus = document.getElementById('safetyStatus');
    fallStatus = document.getElementById('fallStatus');
    obstacleStatus = document.getElementById('obstacleStatus');
    lastUpdate = document.getElementById('lastUpdate');

    // MQTT ì—°ê²° ì„¤ì •
    const clientId = 'webClient_' + Math.random().toString(16).substr(2, 8);
    const isHttps = location.protocol === 'https:';
    const mqttUrl = isHttps ? 'wss://pubcode2.iptime.org:39002' : 'ws://pubcode2.iptime.org:39001';
    
    try {
        client = mqtt.connect(mqttUrl, {
            clientId: clientId,
            clean: true,
            keepalive: 30,
            connectTimeout: 15 * 1000,
            reconnectPeriod: 5000,
            protocolVersion: 4
        });
        setupMQTTEvents();
    } catch (error) {
        console.error('MQTT í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
        updateConnectionStatus(false, 'MQTT ì—°ê²° ì‹¤íŒ¨');
    }
}

// MQTT ë©”ì‹œì§€ ì²˜ë¦¬ í•¨ìˆ˜
function processMessage(data) {
    console.log('ì²˜ë¦¬ ì¤‘ì¸ ë©”ì‹œì§€:', data);
    
    // ë‚™ìƒ ê°ì§€ ì²´í¬
    if (data.includes('"event":"FALL"') || data === 'FALL') {
        handleFallDetection();
        return;
    }
    
    // JSON í˜•íƒœ ë°ì´í„° íŒŒì‹±
    try {
        const jsonData = JSON.parse(data);
        if (jsonData.event === 'FALL') {
            handleFallDetection();
            return;
        }
        if (jsonData.sensor1 !== undefined && jsonData.sensor2 !== undefined) {
            updateSensorDisplay(1, jsonData.sensor1);
            updateSensorDisplay(2, jsonData.sensor2);
            return;
        }
    } catch (e) {
        // JSONì´ ì•„ë‹Œ ê²½ìš° ë‹¤ë¥¸ íŒŒì‹± ë°©ë²• ì‹œë„
    }
    
    // ê±°ë¦¬ ë°ì´í„° íŒŒì‹±
    if (data.includes('Distance Alert!')) {
        handleDistanceAlert(data);
        parseDistanceData(data);
    } else if (data.includes('d1=') && data.includes('d2=')) {
        parseDistanceData(data);
    } else if (data.includes('ì„¼ì„œ1') && data.includes('ì„¼ì„œ2')) {
        parseKoreanDistanceData(data);
    }
}

// ìŒì„± ì•Œë¦¼ í•¨ìˆ˜ (Chrome ë¸Œë¼ìš°ì € í˜¸í™˜)
function speakMessage(message, priority = 'normal') {
    const currentTime = Date.now();
    
    if (priority === 'high' || currentTime - lastSpeechTime > speechCooldown) {
        if ('speechSynthesis' in window) {
            try {
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(message);
                const voices = window.speechSynthesis.getVoices();
                const koreanVoice = voices.find(voice => 
                    voice.lang.includes('ko') || voice.lang.includes('KR')
                );
                
                if (koreanVoice) {
                    utterance.voice = koreanVoice;
                    utterance.lang = koreanVoice.lang;
                } else {
                    utterance.lang = 'ko-KR';
                }
                
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                window.speechSynthesis.speak(utterance);
                lastSpeechTime = currentTime;
                
            } catch (error) {
                console.error('ìŒì„± í•©ì„± ì˜¤ë¥˜:', error);
                showTextAlert(message);
            }
        } else {
            showTextAlert(message);
        }
    }
}

// ë‚™ìƒ ê°ì§€ ì²˜ë¦¬
function handleFallDetection() {
    fallStatus.textContent = 'ğŸš¨ ë‚™ìƒ ê°ì§€ë¨!';
    fallStatus.className = 'alert-message alert-fall';
    safetyStatus.textContent = 'ğŸš¨ ì‘ê¸‰ ìƒí™© ë°œìƒ!';
    safetyStatus.className = 'alert-message alert-fall';

    speakMessage('ê²½ê³ ! ë‚™ìƒì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì‘ê¸‰ ìƒí™©ì…ë‹ˆë‹¤.', 'high');

    setTimeout(() => {
        fallStatus.textContent = 'ì •ìƒ ìƒíƒœ';
        fallStatus.className = 'alert-message alert-normal';
        updateSafetyStatus();
        speakMessage('ë‚™ìƒ ê²½ê³ ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }, 5000);
}

// ì„¼ì„œ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateSensorDisplay(sensorNum, distance) {
    console.log(\`ì„¼ì„œ\${sensorNum} ì—…ë°ì´íŠ¸: \${distance}cm\`);
    
    if (sensorNum === 1) {
        distance1.textContent = distance + ' cm';
        updateSensorStatus(status1, distance);
    } else if (sensorNum === 2) {
        distance2.textContent = distance + ' cm';
        updateSensorStatus(status2, distance);
    }

    // ì¥ì• ë¬¼ ê°ì§€ ì²´í¬
    if (distance < 20) {
        triggerObstacleAlert(sensorNum, distance);
    }
}

// ì¥ì• ë¬¼ ê²½ê³  íŠ¸ë¦¬ê±°
function triggerObstacleAlert(sensorNum, distance) {
    obstacleStatus.textContent = \`âš ï¸ ì„¼ì„œ\${sensorNum}ì—ì„œ ì¥ì• ë¬¼ ê°ì§€! (\${distance}cm)\`;
    obstacleStatus.className = 'alert-message alert-obstacle';
    safetyStatus.textContent = 'âš ï¸ ì£¼ì˜ í•„ìš”';
    safetyStatus.className = 'alert-message alert-obstacle';

    speakMessage(\`ì£¼ì˜! ì„¼ì„œ \${sensorNum}ì—ì„œ \${distance}ì„¼í‹°ë¯¸í„° ê±°ë¦¬ì— ì¥ì• ë¬¼ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\`, 'high');

    setTimeout(() => {
        if (!obstacleStatus.className.includes('alert-obstacle')) return;
        obstacleStatus.textContent = 'ê²½ë¡œ ì•ˆì „';
        obstacleStatus.className = 'alert-message alert-normal';
        updateSafetyStatus();
        speakMessage('ì¥ì• ë¬¼ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ê²½ë¡œê°€ ì•ˆì „í•©ë‹ˆë‹¤.');
    }, 3000);
}`;

        // HTML ì „ì²´ ì½”ë“œ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
        function getFullHtmlCode() {
            return document.documentElement.outerHTML;
        }

        // ëª¨ë‹ˆí„°ë§ ì½”ë“œ í† ê¸€ ê¸°ëŠ¥
        function toggleMonitoringCodeDisplay() {
            const monitoringCodeToggle = document.getElementById('monitoringCodeToggle');
            const monitoringCodeDiv = document.getElementById('monitoringCode');
            const monitoringCodeContent = document.getElementById('monitoringCodeContent');

            if (monitoringCodeToggle.checked) {
                monitoringCodeContent.textContent = monitoringCode;
                monitoringCodeDiv.classList.add('show');
            } else {
                monitoringCodeDiv.classList.remove('show');
            }
        }

        // ëª¨ë‹ˆí„°ë§ ì½”ë“œ ë³µì‚¬ ê¸°ëŠ¥
        function copyMonitoringCode() {
            const monitoringCopyBtn = document.getElementById('monitoringCopyBtn');
            
            navigator.clipboard.writeText(monitoringCode).then(() => {
                monitoringCopyBtn.textContent = 'âœ… ë³µì‚¬ë¨!';
                monitoringCopyBtn.classList.add('copied');
                
                setTimeout(() => {
                    monitoringCopyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                    monitoringCopyBtn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                monitoringCopyBtn.textContent = 'âŒ ì‹¤íŒ¨';
                setTimeout(() => {
                    monitoringCopyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                }, 2000);
            });
        }

        // HTML ì½”ë“œ í† ê¸€ ê¸°ëŠ¥
        function toggleHtmlCodeDisplay() {
            const htmlCodeToggle = document.getElementById('htmlCodeToggle');
            const htmlCodeDiv = document.getElementById('htmlCode');
            const htmlCodeContent = document.getElementById('htmlCodeContent');

            if (htmlCodeToggle.checked) {
                const fullHtmlCode = getFullHtmlCode();
                htmlCodeContent.textContent = fullHtmlCode;
                htmlCodeDiv.classList.add('show');
            } else {
                htmlCodeDiv.classList.remove('show');
            }
        }

        // HTML ì½”ë“œ ë³µì‚¬ ê¸°ëŠ¥
        function copyHtmlCode() {
            const htmlCopyBtn = document.getElementById('htmlCopyBtn');
            const fullHtmlCode = getFullHtmlCode();
            
            navigator.clipboard.writeText(fullHtmlCode).then(() => {
                htmlCopyBtn.textContent = 'âœ… ë³µì‚¬ë¨!';
                htmlCopyBtn.classList.add('copied');
                
                setTimeout(() => {
                    htmlCopyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                    htmlCopyBtn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                htmlCopyBtn.textContent = 'âŒ ì‹¤íŒ¨';
                setTimeout(() => {
                    htmlCopyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                }, 2000);
            });
        }

        // ìŒì„± í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        function testSpeech() {
            console.log('ğŸ¤ ìŒì„± í…ŒìŠ¤íŠ¸ ì‹œì‘');
            speakMessage('ìŠ¤ë§ˆíŠ¸ ì§€íŒ¡ì´ ìŒì„± í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤. ìŒì„±ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ê³  ìˆìŠµë‹ˆë‹¤.', 'high');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            // ì•± ì´ˆê¸°í™” (DOM ìš”ì†Œ ë° MQTT ì—°ê²°)
            initializeApp();
            
            // ìŒì„± ì‹œìŠ¤í…œ ì´ˆê¸°í™”
            initializeSpeech();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            document.getElementById('codeToggle').addEventListener('change', toggleCodeDisplay);
            document.getElementById('copyBtn').addEventListener('click', copyCode);
            document.getElementById('nanoCodeToggle').addEventListener('change', toggleNanoCodeDisplay);
            document.getElementById('nanoCopyBtn').addEventListener('click', copyNanoCode);
            document.getElementById('monitoringCodeToggle').addEventListener('change', toggleMonitoringCodeDisplay);
            document.getElementById('monitoringCopyBtn').addEventListener('click', copyMonitoringCode);
            document.getElementById('htmlCodeToggle').addEventListener('change', toggleHtmlCodeDisplay);
            document.getElementById('htmlCopyBtn').addEventListener('click', copyHtmlCode);
        });
    </script>

</body></html>
